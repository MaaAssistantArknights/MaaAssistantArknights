<UserControl
    x:Class="MaaWpfGui.Views.UserControl.TaskQueue.FightSettingsUserControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:c="clr-namespace:CalcBinding;assembly=CalcBinding"
    xmlns:controls="clr-namespace:MaaWpfGui.Styles.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:dd="urn:gong-wpf-dragdrop"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:helper="clr-namespace:MaaWpfGui.Helper"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:s="https://github.com/canton7/Stylet"
    xmlns:task="clr-namespace:MaaWpfGui.Configuration.Single.MaaTask"
    xmlns:taskQueue_vms="clr-namespace:MaaWpfGui.ViewModels.UserControl.TaskQueue"
    xmlns:ui_vms="clr-namespace:MaaWpfGui.ViewModels.UI"
    d:Background="White"
    d:DataContext="{d:DesignInstance {x:Type taskQueue_vms:FightSettingsUserControlModel}}"
    d:DesignWidth="220"
    s:View.ActionTarget="{Binding}"
    mc:Ignorable="d">
    <StackPanel>
        <Grid d:Visibility="Visible" Visibility="{c:Binding !EnableAdvancedSettings, Source={x:Static ui_vms:TaskQueueViewModel.TaskSettingVisibilities}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" MinWidth="100" />
                    <ColumnDefinition />
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Vertical">
                    <CheckBox
                        Height="30"
                        Margin="6"
                        VerticalContentAlignment="Center"
                        Content="{DynamicResource UseSanityPotion}"
                        IsChecked="{Binding UseMedicine}"
                        IsEnabled="{c:Binding !UseStoneDisplay}"
                        MouseRightButtonUp="{s:Action ToggleCheckBoxNullOnRightClick,
                                                      Target={x:Type helper:CheckBoxHelper}}"
                        ToolTip="{DynamicResource CheckBoxesNotSavedAsNull}" />
                    <CheckBox
                        Height="30"
                        Margin="6"
                        VerticalContentAlignment="Center"
                        Content="{c:Binding 'UseStoneString + (AllowUseStoneSave ? &quot;&quot; : &quot;*&quot;)'}"
                        IsChecked="{Binding UseStone}"
                        MouseRightButtonUp="{s:Action ToggleCheckBoxNullOnRightClick,
                                                      Target={x:Type helper:CheckBoxHelper}}"
                        ToolTip="{DynamicResource CheckBoxesNotSaved}" />
                    <CheckBox
                        Height="30"
                        Margin="6"
                        VerticalContentAlignment="Center"
                        Content="{DynamicResource PerformBattles}"
                        IsChecked="{Binding HasTimesLimited}"
                        MouseRightButtonUp="{s:Action ToggleCheckBoxNullOnRightClick,
                                                      Target={x:Type helper:CheckBoxHelper}}"
                        ToolTip="{DynamicResource CheckBoxesNotSavedAsNull}" />
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Vertical">
                    <hc:NumericUpDown
                        Width="70"
                        Height="30"
                        Margin="6"
                        HorizontalAlignment="Left"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        IsEnabled="{c:Binding !UseStoneDisplay}"
                        Maximum="999"
                        Minimum="0"
                        Value="{Binding MedicineNumber, UpdateSourceTrigger=PropertyChanged}" />
                    <hc:NumericUpDown
                        Width="70"
                        Height="30"
                        Margin="6"
                        HorizontalAlignment="Left"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        Maximum="999"
                        Minimum="0"
                        Value="{Binding StoneNumber, UpdateSourceTrigger=PropertyChanged}" />
                    <hc:NumericUpDown
                        Width="70"
                        Height="30"
                        Margin="6"
                        HorizontalAlignment="Left"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        Maximum="999"
                        Minimum="0"
                        Value="{Binding MaxTimes, UpdateSourceTrigger=PropertyChanged}" />
                </StackPanel>
            </Grid>
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" MinWidth="100" />
                    <ColumnDefinition />
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Vertical">
                    <Grid Margin="6">
                        <CheckBox
                            Height="30"
                            VerticalContentAlignment="Center"
                            Content="{DynamicResource AssignedMaterial}"
                            IsChecked="{Binding IsSpecifiedDrops}"
                            MouseRightButtonUp="{s:Action ToggleCheckBoxNullOnRightClick,
                                                          Target={x:Type helper:CheckBoxHelper}}"
                            ToolTip="{DynamicResource CheckBoxesNotSavedAsNull}" />
                        <controls:TooltipBlock
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            NormalOpacity="0.25"
                            TooltipText="{DynamicResource SpecifiedDropsTip}" />
                    </Grid>
                    <Grid Height="42" Visibility="{c:Binding IsSpecifiedDrops}">
                        <controls:TextBlock
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Text="{DynamicResource Quantity}"
                            TextAlignment="Center" />
                    </Grid>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Vertical">
                    <ComboBox
                        Height="30"
                        Margin="6"
                        VerticalContentAlignment="Center"
                        DisplayMemberPath="Display"
                        DropDownClosed="{s:Action DropsListDropDownClosed}"
                        IsEditable="True"
                        IsTextSearchEnabled="False"
                        ItemsSource="{Binding DropsList}"
                        Loaded="{s:Action MakeComboBoxSearchable,
                                          Target={x:Type ui_vms:SettingsViewModel}}"
                        SelectedValue="{Binding DropsItemId}"
                        SelectedValuePath="Value"
                        Text="{Binding DropsItemName}" />
                    <hc:NumericUpDown
                        Height="30"
                        MinWidth="60"
                        Margin="6"
                        HorizontalAlignment="Left"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        Maximum="1145141919"
                        Minimum="1"
                        Visibility="{c:Binding IsSpecifiedDrops}"
                        Value="{Binding DropsQuantity, UpdateSourceTrigger=PropertyChanged}" />
                </StackPanel>
            </Grid>
            <Grid Grid.Row="2" Visibility="{c:Binding !HideSeries}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition />
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Vertical">
                    <Grid Height="42">
                        <controls:TextBlock
                            x:Name="SeriesTextBlock"
                            Margin="0,6"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Text="{DynamicResource Series}"
                            TextAlignment="Center"
                            TextWrapping="Wrap" />
                        <controls:TooltipBlock
                            Margin="0,5,6,0"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            NormalOpacity="0.25"
                            TooltipText="{DynamicResource SeriesTip}" />
                    </Grid>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Vertical">
                    <ComboBox
                        Height="30"
                        Margin="6"
                        VerticalContentAlignment="Center"
                        d:IsHitTestVisible="True"
                        DisplayMemberPath="Key"
                        IsHitTestVisible="{c:Binding !IsCurrentTaskRunning,
                                                     Source={x:Static ui_vms:TaskQueueViewModel.TaskSettingVisibilities}}"
                        ItemsSource="{Binding SeriesList}"
                        SelectedValue="{Binding Series}"
                        SelectedValuePath="Value" />
                </StackPanel>
            </Grid>
            <Grid Grid.Row="3">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition />
                </Grid.ColumnDefinitions>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <controls:TextBlock
                        Margin="6,11"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Top"
                        Text="{DynamicResource StageSelect}"
                        TextAlignment="Center"
                        TextWrapping="Wrap"
                        Visibility="{c:Binding !UseAlternateStage}" />
                    <controls:TextBlock
                        Margin="6,11"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Top"
                        Text="{DynamicResource StageSelect2}"
                        TextAlignment="Center"
                        TextWrapping="Wrap"
                        Visibility="{c:Binding UseAlternateStage}" />
                    <controls:TooltipBlock
                        Margin="0,5,6,0"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        NormalOpacity="0.25"
                        TooltipText="{DynamicResource CustomStageCodeTip}"
                        Visibility="{c:Binding CustomStageCode}" />
                    <Button
                        Grid.Row="1"
                        Margin="6"
                        VerticalAlignment="Bottom"
                        d:IsHitTestVisible="True"
                        Command="{s:Action AddStageToPlan}"
                        Content="{DynamicResource AddStage}"
                        IsHitTestVisible="{c:Binding !IsCurrentTaskRunning,
                                                     Source={x:Static ui_vms:TaskQueueViewModel.TaskSettingVisibilities}}"
                        Visibility="{c:Binding UseAlternateStage}" />
                </Grid>
                <ListBox
                    Grid.Column="1"
                    MinHeight="{c:Binding 'UseAlternateStage ? 75 : 0'}"
                    Margin="6,6"
                    Padding="-1"
                    VerticalAlignment="Top"
                    HorizontalContentAlignment="Stretch"
                    d:ItemsSource="{d:SampleData ItemCount=2}"
                    dd:DragDrop.DragDropContext="{Binding RelativeSource={RelativeSource Self}}"
                    dd:DragDrop.IsDragSource="{Binding UseAlternateStage}"
                    dd:DragDrop.IsDropTarget="{Binding UseAlternateStage}"
                    BorderThickness="{c:Binding 'UseAlternateStage ? 1 : 0'}"
                    ClipToBounds="False"
                    IsHitTestVisible="{c:Binding !IsCurrentTaskRunning,
                                                 Source={x:Static ui_vms:TaskQueueViewModel.TaskSettingVisibilities}}"
                    ItemsSource="{Binding Path=StagePlan}"
                    PreviewMouseWheel="{s:Action RouteMouseWheelToParentExceptScrollable,
                                                 Target={x:Type helper:MouseWheelHelper}}"
                    Style="{DynamicResource NoSelectedHighlightListBoxStyle}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid x:Name="StageItemGrid" Margin="0,0,0,-2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <Grid
                                    Grid.Column="0"
                                    Height="30"
                                    Margin="-10,0,0,0">
                                    <!--  当 CustomStageCode 为 false 时显示 ComboBox  -->
                                    <ComboBox
                                        ItemsSource="{Binding StageListSource, Source={x:Static ui_vms:TaskQueueViewModel.FightTask}}"
                                        ScrollViewer.CanContentScroll="False"
                                        SelectedValue="{Binding Stage}"
                                        SelectedValuePath="Value"
                                        Visibility="{c:Binding !CustomStageCode,
                                                               Source={x:Static ui_vms:TaskQueueViewModel.FightTask}}">

                                        <ComboBox.ItemContainerStyle>
                                            <Style BasedOn="{StaticResource ComboBoxItemBaseStyle}" TargetType="ComboBoxItem">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsVisible}" Value="False">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ComboBox.ItemContainerStyle>
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Display}">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsOutdated}" Value="True">
                                                                    <Setter Property="TextDecorations" Value="Strikethrough" />
                                                                    <Setter Property="Foreground" Value="{DynamicResource ErrorLogBrush}" />
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding IsOpen}" Value="False">
                                                                    <Setter Property="Opacity" Value="0.5" />
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding IsOpen}" Value="True">
                                                                    <Setter Property="Opacity" Value="1" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>

                                    <!--  当 CustomStageCode 为 true 时显示 TextBox  -->
                                    <TextBox
                                        Height="30"
                                        hc:InfoElement.Placeholder="{DynamicResource DefaultStage}"
                                        Opacity="{c:Binding 'IsOpen ? 1 : 0.5'}"
                                        Text="{Binding Stage, UpdateSourceTrigger=PropertyChanged}"
                                        ToolTip="{DynamicResource CustomStageCodeTip}"
                                        Visibility="{c:Binding CustomStageCode,
                                                               Source={x:Static ui_vms:TaskQueueViewModel.FightTask}}" />
                                </Grid>

                                <Border Grid.Column="1">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <MultiDataTrigger>
                                                    <MultiDataTrigger.Conditions>
                                                        <Condition Binding="{Binding IsMouseOver, ElementName=StageItemGrid}" Value="True" />
                                                        <Condition Binding="{c:Binding DataContext.UseAlternateStage, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}" Value="True" />
                                                    </MultiDataTrigger.Conditions>
                                                    <Setter Property="Visibility" Value="Visible" />
                                                </MultiDataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <!--  拖动手柄  -->
                                        <Button
                                            Margin="0"
                                            Padding="2"
                                            VerticalAlignment="Stretch"
                                            hc:IconElement.Geometry="{StaticResource AlignHStretchGeometry}"
                                            hc:IconElement.Height="10"
                                            hc:IconElement.Width="10"
                                            hc:VisualElement.HighlightBackground="Transparent"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Cursor="Hand" />
                                        <!--  删除按钮  -->
                                        <Button
                                            Grid.Column="1"
                                            Padding="2"
                                            VerticalAlignment="Stretch"
                                            hc:IconElement.Geometry="{StaticResource CloseGeometry}"
                                            hc:IconElement.Height="10"
                                            hc:IconElement.Width="10"
                                            hc:VisualElement.HighlightBackground="Transparent"
                                            hc:VisualElement.HighlightForeground="{DynamicResource PrimaryBrush}"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Command="{s:Action RemoveStageFromPlan}"
                                            CommandParameter="{c:Binding DataContext,
                                                                         RelativeSource={RelativeSource Self}}"
                                            Visibility="{c:Binding 'DataContext.StagePlan.Count > 1',
                                                                   RelativeSource={RelativeSource AncestorType={x:Type UserControl}}}" />
                                    </Grid>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Grid>

        <StackPanel d:Visibility="Visible" Visibility="{c:Binding EnableAdvancedSettings, Source={x:Static ui_vms:TaskQueueViewModel.TaskSettingVisibilities}}">
            <StackPanel>
                <CheckBox
                    Margin="0,10"
                    Content="{DynamicResource UseCustomAnnihilation}"
                    IsChecked="{Binding UseCustomAnnihilation}" />
                <ComboBox
                    Height="30"
                    d:IsHitTestVisible="True"
                    DisplayMemberPath="Key"
                    IsHitTestVisible="{c:Binding !IsCurrentTaskRunning,
                                                 Source={x:Static ui_vms:TaskQueueViewModel.TaskSettingVisibilities}}"
                    ItemsSource="{Binding AnnihilationModeList}"
                    SelectedValue="{Binding AnnihilationStage}"
                    SelectedValuePath="Value"
                    Visibility="{c:Binding UseCustomAnnihilation}" />
            </StackPanel>
            <StackPanel Margin="0,10" Orientation="Horizontal">
                <CheckBox Content="{DynamicResource DrGrandet}" IsChecked="{Binding IsDrGrandet}" />
                <controls:TooltipBlock TooltipText="{DynamicResource DrGrandetTip}" />
            </StackPanel>
            <CheckBox Margin="0,10" IsChecked="{Binding UseExpiringMedicine}">
                <TextBlock
                    Block.TextAlignment="Left"
                    Text="{DynamicResource UseExpiringMedicine}"
                    TextWrapping="Wrap" />
            </CheckBox>
            <CheckBox
                Margin="0,10"
                Content="{DynamicResource HideSeries}"
                IsChecked="{Binding HideSeries}" />
            <CheckBox
                Margin="0,10"
                Content="{DynamicResource AllowUseStoneSave}"
                IsChecked="{Binding AllowUseStoneSave}" />
            <StackPanel Margin="0,10" Orientation="Horizontal">
                <CheckBox Content="{DynamicResource CustomStageCode}" IsChecked="{Binding CustomStageCode}" />
                <controls:TooltipBlock TooltipText="{DynamicResource CustomStageCodeTip}" />
            </StackPanel>
            <ComboBox
                hc:InfoElement.Title="{DynamicResource FightStageResetMode}"
                DisplayMemberPath="Display"
                ItemsSource="{Binding StageResetModeList}"
                SelectedValue="{Binding StageResetMode}"
                SelectedValuePath="Value" />
            <CheckBox
                Margin="0,10"
                Content="{DynamicResource UseAlternateStage}"
                IsChecked="{Binding UseAlternateStage}" />
            <CheckBox
                Margin="0,10"
                Content="{DynamicResource HideUnavailableStage}"
                IsChecked="{Binding HideUnavailableStage}" />
            <StackPanel Margin="0,10" Orientation="Horizontal">
                <CheckBox Content="{DynamicResource UseWeeklySchedule}" IsChecked="{Binding UseWeeklySchedule}" />
                <controls:TooltipBlock TooltipText="{DynamicResource UseWeeklyScheduleTip}" />
            </StackPanel>
            <ListBox
                MaxHeight="300"
                Margin="6,5"
                HorizontalContentAlignment="Stretch"
                d:ItemsSource="{d:SampleData ItemCount=3}"
                ItemsSource="{Binding Path=WeeklyScheduleSource}"
                PreviewMouseWheel="{s:Action RouteMouseWheelToParent,
                                             Target={x:Type helper:MouseWheelHelper}}"
                ScrollViewer.VerticalScrollBarVisibility="Auto"
                Style="{DynamicResource NoSelectedHighlightListBoxStyle}"
                Visibility="{c:Binding UseWeeklySchedule}">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <CheckBox
                            HorizontalAlignment="Left"
                            VerticalAlignment="Center"
                            Content="{Binding Display}"
                            IsChecked="{Binding Value}" />
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
            <controls:TextBlock
                Margin="0,5"
                HorizontalAlignment="Center"
                FontWeight="Bold"
                Text="{DynamicResource MultiTasksShareTip}"
                TextAlignment="Left"
                TextWrapping="Wrap" />
            <CheckBox
                Margin="0,10"
                Content="{DynamicResource AutoRestartOption}"
                IsChecked="{Binding AutoRestartOnDrop}" />
        </StackPanel>
    </StackPanel>
</UserControl>
