name: Release Package Distribution

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release Tag (empty for latest)"
        type: string
        required: false
        default: ""
      mirrorchyan:
        description: "Upload to MirrorChyan"
        type: boolean
        required: false
        default: true
      winget:
        description: "Upload to WinGet"
        type: boolean
        required: false
        default: true
      maa_cos:
        description: "Upload to MAA COS"
        type: boolean
        required: false
        default: true

env:
  RELEASE_TAG_RAW: ${{ github.event.inputs.release_tag || 'latest' }}

jobs:
  meta:
    name: Define Release Tag
    if: ${{ github.repository_owner == 'MaaAssistantArknights' }}
    runs-on: ubuntu-latest

    outputs:
      RELEASE_TAG: ${{ steps.define_release_tag.outputs.RELEASE_TAG }}

    steps:
      - name: Get latest release tag
        id: get_latest
        if: ${{ env.RELEASE_TAG_RAW == 'latest' }}
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          excludes: "draft"

      - name: Define release tag
        id: define_release_tag
        run: |
          if [ "${{ env.RELEASE_TAG_RAW }}" == "latest" ]; then
            echo "RELEASE_TAG=${{ steps.get_latest.outputs.release }}" >> $GITHUB_OUTPUT
          else
            echo "RELEASE_TAG=${{ env.RELEASE_TAG_RAW }}" >> $GITHUB_OUTPUT
          fi

  mirrorchyan:
    name: Upload to MirrorChyan
    needs: meta
    if: ${{ github.event.inputs.mirrorchyan == 'true' }}
    runs-on: ubuntu-latest
    continue-on-error: true

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: win
            arch: x64
            filename: "*MAA-*-win-x64.zip"
            extra_zip: false
          - os: win
            arch: arm64
            filename: "*MAA-*-win-arm64.zip"
            extra_zip: false
          - os: macos
            arch: arm64
            filename: "MAA-*-macos-universal.dmg"
            extra_zip: true
          - os: macos
            arch: x64
            filename: "MAA-*-macos-universal.dmg"
            extra_zip: true

    env:
      RELEASE_TAG: ${{ needs.meta.outputs.RELEASE_TAG }}

    steps:
      - name: Upload MAA ${{ matrix.os }} ${{ matrix.arch }}
        uses: MirrorChyan/uploading-action@v1
        continue-on-error: true
        with:
          filetype: latest-release
          filename: ${{ matrix.filename }}
          extra_zip: ${{ matrix.extra_zip }}
          tag: ${{ env.RELEASE_TAG }}
          mirrorchyan_rid: MAA
          github_token: ${{ secrets.GITHUB_TOKEN }}
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          upload_token: ${{ secrets.MirrorChyanUploadToken }}
          os: ${{ matrix.os }}
          arch: ${{ matrix.arch }}

  winget:
    name: Upload to WinGet
    needs: meta
    if: ${{ github.event.inputs.winget == 'true' }}
    runs-on: windows-latest
    continue-on-error: true

    env:
      RELEASE_TAG: ${{ needs.meta.outputs.RELEASE_TAG }}

    steps:
      - name: Upload MAA to WinGet
        uses: vedantmgoyal9/winget-releaser@main
        with:
          identifier: MaaAssistantArknights.MaaAssistantArknights
          version: ""
          installers-regex: "-win-"
          max-versions-to-keep: 0
          release-tag: ${{ env.RELEASE_TAG }}
          fork-user: MaaAssistantArknights
          token: ${{ secrets.MAABOT_WINGET_TOKEN }}

  maa_cos:
    name: Upload to MAA COS
    needs: meta
    if: ${{ github.event.inputs.maa_cos == 'true' && !contains(needs.meta.outputs.RELEASE_TAG, '-') }}
    runs-on: windows-latest
    continue-on-error: true
    env:
      FILENAME: MAA-v${{ needs.meta.outputs.RELEASE_TAG }}-win-x64.zip
    steps:
      - uses: robinraju/release-downloader@v1
        with:
          repository: 'MaaAssistantArknights/MaaAssistantArknights'
          latest: true
          fileName: ${{ env.FILENAME }}
          out-file-path: 'downloads'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to COS
        uses: zkqiang/tencent-cos-action@v0.1.0
        with:
          args: upload -rs downloads/${{ env.FILENAME }} MAA/MAA-latest-win-x64.zip
          secret_id: ${{ secrets.MISTEO_MAA_COS_SECRET_ID }}
          secret_key: ${{ secrets.MISTEO_MAA_COS_SECRET_KEY }}
          bucket: ${{ secrets.MISTEO_MAA_COS_BUCKET }}
          region: ${{ secrets.MISTEO_MAA_COS_REG }}
