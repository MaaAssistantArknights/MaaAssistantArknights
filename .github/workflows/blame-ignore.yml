name: Blame Ignore Commit

on:
  workflow_dispatch:

jobs:
  blame-ignore:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false # Needed to bypass protection rules in Push changes

      - name: Get last checked commit
        run: |
          if [ -f .last-checked-commit ]; then
            LAST_CHECKED_COMMIT=$(cat .last-checked-commit)
          else
            LAST_CHECKED_COMMIT=$(git rev-list --max-parents=0 HEAD)
          fi

          COMMITS_BEHIND=$(git rev-list --count $LAST_CHECKED_COMMIT..HEAD)
          echo "fetch_depth=$((COMMITS_BEHIND + 1))" >> $GITHUB_ENV

      - name: Checkout repository with calculated depth
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ env.fetch_depth }}
          persist-credentials: false # Needed to bypass protection rules in Push changes
  
      - name: Process commits and update blame ignore list
        run: |
          git log -n ${{ env.fetch_depth }} --pretty=format:"%H %s" --grep="\[blame ignore\]" > commits.txt

          awk '{print $1}' commits.txt >> .git-blame-ignore-revs

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git rev-parse HEAD > .last-checked-commit

          git add .last-checked-commit .git-blame-ignore-revs
          git commit -m "chore: auto blame ignore" -m "[skip changelog]"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ github.ref }}
          github_token: ${{ secrets.MAA_RESOURCE_SYNC }}
