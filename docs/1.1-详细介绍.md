# MAA使用说明

## 功能介绍

### 一键长草：刷理智

- 若关卡选择中没有你需要的关卡，请在MAA中选择 `当前/上次`，然后在游戏中手动定位关卡，确保画面停留在有 **开始按钮** 和 **代理指挥** 的关卡详情界面。
  - 若当前不处于此界面，则 `当前/上次` 会自动进入游戏中“上次作战”的关卡（以终端首页右下角记录为准）。
  - 也可以在 `任务设置` - `刷理智` - `高级设置` 中启用 `手动输入关卡名` 手动输入关卡编号。目前支持导航的关卡有：
    - 全部主线关卡，可在关卡末尾添加 `-NORMAL` 或 `-HARD` 来切换标准或磨难关卡。
    - 龙门币、作战记录的 5 / 6 关，但必须输入 `CE-6` / `LS-6` ，会在第六关无法代理的情况下自动切换至第五关。
    - 技能书、采购凭证、碳本第 5 关，必须输入 `CA-5` / `AP-5` / `SK-5`。
    - 芯片本，必须输入完整关卡编号，如 `PR-A-1`。
    - 剿灭作战，必须输入 `Annihilation`。
    - 部分别传，只支持 `OF-1` / `OF-F3` / `GT-5`。
    - 当期 SS 活动 后三关，在自动访问 [API](https://ota.maa.plus/MaaAssistantArknights/api/gui/StageActivity.json) 下载更新后会在主界面下方显示。

<details><summary>示例画面</summary>

![示例画面](https://user-images.githubusercontent.com/5153875/196309375-73a93b83-e59b-441c-913f-122d4a9fc46c.png)

</details>

- 主界面上的 `吃理智`、`吃石头`、`指定次数`、`指定材料` 四个选项为**短路开关（或门）**，即 **四个选项中的任一条件** 达到，均会视为任务完成，停止刷理智。
  - 其中：
    - `吃理智` 指定吃理智药的 **次数**（通常每次 1 份，即理智耗尽后开始作战时游戏默认选择的一份；小样由于理智较少可能会使用多次，请注意自行计算次数）
    - `吃石头` 指定碎石多少次（每次 1 颗）
    - `指定次数` 指定刷多少次图（例如“刷 15 次后停止”）
    - `指定材料` 指定刷多少个指定的材料（例如“获取 5 个固源岩后停止”）

|  例 | 吃理智药 |  吃石头 | 指定次数  | 指定材料 | 结果                                                                                                                                                    |
|:---:|:-------:|:-------:|:-------:|:-------:|---------------------------------------------------------------------------------------------------------------------------------------------------------|
|  A  |   999   |    10   |    1    |    x    | 会尝试吃理智药和/或石头，直到刷满 **一次**，满足了 `指定次数：1` 的条件，即视为任务完成，停止刷理智；如果一开始理智药不够、石头不够、现有的理智也不够就会不刷图自动结束。|
|  B  |    x    |    x    |   100   |    x    | 会尝试刷满100次，但在当前可用理智全部刷完后（可能只刷了几次），由于满足了 `不吃理智药` 、 `不吃石头` 的条件，无理智可用，视为任务完成，停止刷理智。                    |
|  C  |    1    |    x    |   100   |    x    | 会尝试刷满100次，期间最多吃 1 次理智药，如果吃了一次理智药理智也刷完了，由于满足了 `吃理智药：1` 、 `不吃石头` 的条件，无理智可用，视为任务完成，停止刷理智。           |
|  D  |   999   |    x    |   100   |3 个固源岩| 会尝试刷满100次，期间会吃 999 次理智药，但如果在这期间累计刷出了3个固源岩，由于满足了 `指定材料：3个固源岩` 的条件，视为任务完成，停止刷理智。                        |

- `指定材料` 与 `关卡选择` 是两个互相独立的逻辑。
  - `指定材料` 只是以材料个数作为任务完成依据，并不是说你指定了材料就会帮你导航到对应关卡。
- 支持未勾选 `代理指挥` 时自动勾选，避免你蹭信赖后忘记勾选的尴尬~
- 支持识别并显示材料掉落，且会自动上传 [企鹅物流数据统计](https://penguin-stats.cn/)，并可设置企鹅物流用户 ID。
- 掉线后或凌晨 4 点闪断后会自动重连，继续刷游戏中的**上次**关卡，如需跨天请注意检查上次关卡选择。
- 支持打完升级的情况；支持代理失败的情况，会自动放弃本次行动。
- 剿灭相关：
  - 支持剿灭模式自动使用 `全权委托`。
  - MAA 会点击终端首页右上角剿灭按钮进行跳转，请确保当期剿灭已成功解锁 `全权委托` 并 400 杀。
  - 每当当期剿灭刷新或重新安装明日方舟时，从剿灭 `开始战斗` 页面返回会自动展开 `情报汇总`，请提前关闭此页面以防止任务卡住。
- 支持剩余理智清空：
  - 主任务刷完后，自动跳到指定关卡清理剩余的“边角”理智（如剩下的理智拿来刷 1-7）。
  - 如果剩余理智不够清空（比如要刷 1-7 但连6理智都不够）则会立即结束任务。

### 一键长草：基建换班

#### 换班策略

- 自动计算并选择 **单设施内的最优解**，支持所有通用类技能和特殊技能组合；支持识别经验书、赤金、源石碎片、芯片，分别使用不同的干员组合！

#### 基建工作心情阈值

- 自动识别心情进度条的百分比。如干员心情小于该阈值，不会再去上班，直接进驻宿舍。

#### 特殊说明

- 基建换班目前均为单设施最优解，但非跨设施的全局最优解。例如 `巫恋+龙舌兰`、`红云+稀音` 等这类单设施内的组合，都是可以正常识别并使用的；`迷迭香`、`红松骑士团` 这类多个设施间联动的体系，暂不支持使用。
- 若 `无人机用途` 选择 `贸易站-龙门币` ，则将额外识别是否有 `巫恋组`，并优先为其使用。
- 会客室仅缺一个线索时，会选择对应流派的干员；否则会选择通用干员。
- 会客室仅当自有线索满时，才会送出线索，并且只送三个。有需要的同学可自行修改 `resource/tasks.json` 中 `SelectClue` - `maxTimes` 字段，自定义送出个数。
- 若不希望 `艾丽妮` 等干员在训练室未训练时被进驻到宿舍，可在设置中打开 `不将已进驻干员放入宿舍`。但可能会带来加工站中心情不满的干员也不进驻宿舍的问题。
- 控制中枢策略太过复杂，目前只考虑 `阿米娅`、`诗怀雅`、`凯尔希`、`彩虹小队` 及其他心情 +0.05 的干员，后续逐步优化。

#### 自定义基建换班（测试功能）

- 一图流的大佬们帮忙写了一个 [排班生成器](https://yituliu.site/riicCal/)，可参考 [文档](3.6-基建排班协议.md) 使用。
- 在 MAA 文件夹 `/resource/custom_infrast/` 下内置了几套极限效率的作业，可用作参考。（全干员且精二大佬可以试着直接用）

### 一键长草：获取信用及购物

- 会自动访问好友获取信用点。
- 借助战赚信用：
  - 使用助战干员通关一次火蓝之心 `OF-1` 关卡，如果未解锁该关卡请不要选择该项。
  - 可以通过编辑 `resource\copilot\OF-1_credit_fight.json` 来修改 OF-1 自动战斗流程（一般来说不建议修改）。
  - 关卡选择为 `当前/上次` 时不生效。

### 一键长草：自动肉鸽

- 请在 MAA `任务设置` - `自动肉鸽` 中选择所要探索的主题，否则可能会因为默认选择最新一期主题而出现问题。
  - 请在游戏内将对应肉鸽主题置顶在终端处。
  - 如果存在非目标主题的探索（如你打算用MAA刷水月，但现在还有一个未完成的傀影主题探索），请手动结束它。
  - 如果 MAA 在难度选择界面卡住/反复进出，请先手动选好难度再启动本功能。
- 设置中可选择分队、开局干员（仅单个干员名）等。
- 支持自动识别干员及练度，并自动选择较优干员及技能。
- 支持识别商店物品，优先购买更厉害的收藏品。
- 支持掉线重连、支持凌晨 4 点更新后继续回去刷。
- 战斗过程中如果刮痧了一直打不完，超过 5 分钟会自动撤退所有地面单位；超过 6 分钟会自动放弃当局战斗，不会卡住。
- 如果任务出现问题卡住了，会自动放弃当次探索并重试。但如果经常在某个地方卡住然后放弃、严重影响效率的，欢迎提个 issue 反馈一下~

### 自动战斗

- 欢迎使用作业分享站 [prts.plus](https://prts.plus)，[抄作业.com](https://抄作业.com) 使用&分享作业文件！

#### 抄作业

- 本功能需要在有 `开始行动` 的编队选择界面开始运行。
- 若需要选择助战等，关闭 `自动编队` 功能并手动编队后再运行即可。
- 记得在作业分享站上给好用的作业点赞哦！

![image](https://user-images.githubusercontent.com/18511905/189662951-5f9d6d88-3c23-49b3-a58f-c35388b2d5d7.png)

#### 写作业

- 可以在 [作业编辑器](https://prts.plus/create) 上制作，可参考 [文档](3.3-战斗流程协议.md) 使用。
- 地图坐标获取：填写 `stage_name` 后直接开一局，会在目录下生成 `map.png`，可以用于参考。也可参考 [PRTS.Map](https://map.ark-nights.com/areas) 网站，在设置中将 `坐标展示` 修改为 `MAA` 后使用。
- 支持演习模式，不用一直浪费理智测试的。
- 推荐在作业描述里填上你的署名（作者名）、参考的攻略视频链接、其他想说的等等。
- 欢迎与我们一起讨论作业制作等问题 [作业企鹅群 1169188429](https://jq.qq.com/?_wv=1027&k=QZcGcJ9G)。

#### 作业视频识别

- 将视频文件放入自动战斗中，点击 “开始” 启动作业视频识别。
- 仅支持 16:9 的 720p 或更高分辨率的视频。视频内容不能出现黑框、异形屏校正、模拟器边框等其他元素。

### 公开招募

- **自动公招和公招识别是两个独立的功能！**
- 自动公招支持使用 `加急许可`，全自动连续公招！请进入 `任务设置` - `自动公招` 中选择 `自动使用加急许可` ，并将修改 `每次执行时最大招募次数` 。
- 出 1、5、6 星都会弹出通知提示。
- 自动公招时自动选取数据上传 [企鹅物流数据统计](https://penguin-stats.cn/) 和 [材料一图流](https://yituliu.site/)。

### 仓库识别（测试功能）

- 若自动跳转失败，请手动切换到仓库 `养成材料` 界面开始功能。目前仅支持导出到[企鹅物流刷图规划器](https://penguin-stats.cn/planner)、[明日方舟工具箱](https://arkn.lolicon.app/#/material)、[明日方舟 - 干员培养表](https://ark-nights.com/settings)，后面可能会用来做一些更实用的功能。（画饼
- 如您是某个数据站站长，也欢迎联系我们适配贵站的材料 JSON 协议~

## 设置介绍

除了 `设置` 选项卡 ，Windows MAA 里还有 `任务设置` ，点击 `一键长草` 的任务列表右侧的 `齿轮` ，就可以在一键长草界面里切换不同的任务设置啦~

要注意点击 `常规设置` `高级设置` 也会切换 `任务设置`哟~

### 自定义连接

#### 获取 adb 路径

- 方式 1 : 下载 adb 并手动设置连接
  - （仅 Windows 用户）下载 [adb](https://dl.google.com/android/repository/platform-tools-latest-windows.zip) 并解压。推荐解压到 MAA 目录下。
  - 进入软件 `设置` - `连接设置`，选择 `adb.exe` 的文件路径，填写 adb 地址（需要填写 IP + 端口，例如 `127.0.0.1:5555`），并选择模拟器类型。

- 方式 2 : 查找模拟器 adb 运行端口并连接
  - 对于本身带有 adb 的模拟器，可按照 [确认 adb 地址一节](1.2-常见问题.md#方式-1-确认-adb-及连接地址正确) 找到 adb 可执行文件位置。
  - Mac 安卓模拟器一般安装在 `/Application/` 目录下，右键点击 `[模拟器名称].app` 后选择显示包内容，在目录下查找 adb 可执行文件即可。

#### 获取端口号

- 方式 1 : 直接使用 adb 命令查看运行端口

  **使用找到的 adb 可执行文件名替代下面命令中的 adb** ，而后执行：

  ```sh
  # mac/linux/windows cmd
  adb devices
  # windows PowerShell
  .\adb devices
  ```

  大部分模拟器 adb 运行命令后将会按如下形式输出， `[ADBPORT]` 为具体数字：

  ```sh
  List of devices attached
        127.0.0.1:[ADBPORT] device
  # may be more output like the above one
  ```

  使用 `127.0.0.1:[ADBPORT]` 作为连接地址即可（ `[ADBPORT]` 替换为实际数字）

- 方式 2 : 使用系统命令查看模拟器调试端口

  若使用 adb 命令的输出结果并不能显示 `127.0.0.1:[port]` 形式的端口信息，可以采取下面的方式查看：
    1. 首先运行一遍 adb 可执行程序（需要启动 adb daemon 进程），并且运行需要打开明日方舟应用的模拟器。
    2. 然后使用系统命令查看 adb 进程的端口信息。

    Windows 命令

    可以使用 `win` + `R` 输入 `cmd` 打开命令行，使用如下命令查看:

    ```sh
    for /F "tokens=1,2" %A in ('"tasklist | findstr "adb""') do ( ^
    netstat -ano | findstr "%B" |)
    ```

    Mac / Linux 命令

    启动模拟器后在终端中输入：

    ```sh
    tmp=$(sudo ps aux | grep "[a]db" | awk '{print $2}') && \
    sudo netstat -vanp tcp | grep -e "\b$tmp"
    ```

    将会输出如下形式结果，其中 `[PID]` 为 adb 实际运行的进程号，`[ADBPORT]` 为目标模拟器 adb 的远程连接端口，`[localport]` 为进程本地地址，无需关心（Mac 运行结果中也会有其他无需关心的指标）：

    ```sh
    > ( netstat -ano | findstr "[PID]" )
    TCP  127.0.0.1:[localport]   127.0.0.1:0.0.0.0     LISTENING   [PID]
    TCP  127.0.0.1:[localport]   127.0.0.1:[ADBPORT]   ESTABLISHED [PID]
    # ...
    # maybe more output like the above line
    ```

  使用结果中 `127.0.0.1:[ADBPORT]` （替换 `[ADBPORT]` 为实际数字）作为模拟器 adb 实际连接地址填入 `设置` - `连接设置` - `连接地址`。

### 自动启动多开模拟器

- 若需要多开模拟器同时操作，可将 MAA 文件夹复制多份，使用 **不同的 MAA**、**同一个 adb.exe**、**不同的连接地址** 来进行连接。
- **以[蓝叠国际版](1.3-模拟器支持.md##-✅-[蓝叠模拟器国际版](https://www.bluestacks.com/tw/index.html)（最稳定👍）)为例**，介绍两种启动多开模拟器的方式。

  - 通过为 `HD-Player.exe` 附加命令来进行多开操作。

    1. 单独启动对应的模拟器
    2. 打开任务管理器，找到对应模拟器进程，转到详细信息选项卡，右键上方列，点击 `选择列`，勾选 `命令行`。
    3. 在多出来的 `命令行` 列中找到 `...\Bluestacks_nxt\HD-Player.exe"` 后的内容。
    4. 将找到的类似于 `--instance Nougat32` 的内容填写到 `启动设置` - `附加命令` 中。

    注：操作结束后建议重新隐藏 `步骤 2` 中打开的 `命令行` 列以防止卡顿。
    - 例子：

      ``` bash
      多开1:
      模拟器路径: C:\Program Files\BlueStacks_nxt\HD-Player.exe
      附加命令: --instance Nougat32 --cmd launchApp --package "com.hypergryph.arknights"
      多开2:
      模拟器路径: C:\Program Files\BlueStacks_nxt\HD-Player.exe
      附加命令: --instance Nougat32_1 --cmd launchApp --package "com.hypergryph.arknights.bilibili"
      ```

      其中 `--cmd launchApp --package` 部分为启动后自动运行指定包名应用，可自行更改。

  - 通过使用模拟器或应用的快捷方式来进行多开操作。

    1. 打开多开管理器，新增对应模拟器的快捷方式。
    2. 将模拟器快捷方式的路径填入 `启动设置` - `模拟器路径` 中。

    注：部分模拟器支持创建应用快捷方式，可直接使用应用的快捷方式直接启动模拟器并打开明日方舟。
    - 例子：

      ``` bash
      多开1:
      模拟器路径: C:\ProgramData\Microsoft\Windows\Start Menu\Programs\BlueStacks\多开1.lnk
      多开2:
      模拟器路径: C:\ProgramData\Microsoft\Windows\Start Menu\Programs\BlueStacks\多开2-明日方舟.lnk
      ```

    若使用 `模拟器路径` 进行多开操作，建议将 `启动设置` - `附加命令` 留空。

### 开始前/结束后脚本

- v4.13.0 后支持设置开始前/结束后脚本，可在任务前后自动执行批处理文件。
- 需填写批处理文件即 `.bat` 的路径。

## 其他说明

- 主界面上要执行的任务，是可以拖动改变顺序的。同样设置中基建换班的顺序，也是可以拖动改变的。
- 主界面和设置中更改的配置一般都会自动保存，含有 `*` 号的选项除外。
- 所有点击操作，都是点击按钮内随机位置，并模拟泊松分布（按钮偏中间位置点的概率大，越往旁边点到的概率越小）。
- 底层算法纯 C++ 开发，并设计了多重缓存技术，最大限度降低 CPU 和内存占用。
- 软件支持自动更新 ✿✿ヽ(°▽°)ノ✿ ，推荐非杠精的同学使用公测版，一般来说更新快且 bug 少。（什么 MIUI (╯‵□′)╯︵┻━┻
- 如果新版本自动下载失败，可手动下载 OTA 压缩包后直接放到 MAA 目录下，会自动更新的。
- 在 Windows 版本中，MAA 目录下 `config` 文件夹中的 `gui.json` 记录了各种设置，如果下载了新的完整包可以将此文件夹复制到新的 MAA 目录下。（如果复制完启动报错可尝试恢复 `bak` 备份文件或删除后重新设置）。
