# MAA使用説明書

## 詳細な説明

### ワンクリックで周回：理性を有効活用

- MAAで`現在/前回`を選択し、**任務開始**と**自動指揮**がゲーム画面に存在することを確認し、ゲーム内で手動でステージを選択します。
- ステージ選択画面でない場合は、`現在/前回`で自動的に最後に戦ったステージ（端末のトップページの右下に記録されている）に移動することができます。
- `タスク設定` - `作戦` で`ステージ名を入力する` をチェックした場合, メインストーリーの全ステージ, ドロップダウンのリスト（`1-7`, `S3-2`, `CE-6` など）を選択できます。

- MAAで`現在/前回`を選択し、**任務開始**と**自動指揮**がゲーム画面に存在することを確認し、ゲーム内で手動でステージを選択します。
  - もし、このページにいない場合、「現在/前回」は最後にプレイしたステージに自動的に移動します（端末のホームページ右下の記録に従います）。
  - 「設定」-「戰鬥設定」で「ステージ名を手動入力する」を有効にすることもできます。現在サポートされているナビゲーションステージは以下の通りです。
    - すべてのメインストーリーステージ。通常または厄難奮戦に切り替えるには、ステージの末尾に「-NORMAL」または「-HARD」を追加します。
    - 龍門幣、作戦記録の5/6ステージ。ただし、「CE-6」/「LS-6」を入力する必要があります。6ステージを実行できない場合は、自動的に5ステージに移行します。
    - アーツ学、購買資格証、建築資材。 「CA-5」/「AP-5」/「SK-5」を入力する必要があります。
    - SoCの場合のみ、完全なステージ番号を入力する必要があります。例：「PR-A-1」。
    - 「Annihilation」（殲滅作戦）。
    - 「OF-1」/「OF-F3」/「GT-5」のみサポートされます。
    - 現在のSSイベントの最後の3つのステージ。更新が自動的にダウンロードされた後、メイン画面に対応するメッセージが表示されます。

<details><summary>画面例</summary>

![画面例](https://user-images.githubusercontent.com/63186641/203410007-ef9c1cab-10f3-4d7c-8048-a3e11cdadb75.png)

</details>

- スタート画面の `理性剤使用数`、`割る源石の数`、`周回数指定`、`素材を限定` の4つのオプションはショートスイッチですので、**4つのオプションのいずれかを達成した場合**、それはタスクの完了と見なされます。
  - 以下のうち：
    - `理性剤使用数` 理性剤を飲む**回数**（普通は毎回 1 個使用しますが、理性が不足した際にデフォルトで選ばれる理性剤が選択されます（試供回復材など理性回復量が少ない場合もあるため、自分でも数を把握するようにしてください）)
    - `割る源石の数` 源石を割る回数を指定（1回につき 1 個）
    - `周回数指定` ステージを何回周回するか指定（例“15 周 で停止”）
    - `素材を限定` 特定の素材のドロップ数が手に入るまで周回（例“5 個 初級源岩獲得で停止”）

| 例 | 理性剤使用数 | 割る源石の数 | 周回数指定 |  素材を限定 | 結果                                                                                                                                          |
|:--:|:--------:|:------:|:--------:|:---------:|-----------------------------------------------------------------------------------------------------------------------------------------------|
|  A |    999   |   10   |     1    |     ✖     | 理性材/純正源石を**1回**以上摂取し、`周回数：1`回の条件を完了すると、即座に停止。理性不足の状態で純正源石か理性剤が不足している場合は摂取せずに自動的に終了します。                                                                    |
|  B |     ✖    |    ✖   |    100   |     ✖     | 100回ステージを実行しようとしますが、現在使用可能な理性を消費後（おそらく数回）に、`理性剤`、`純正源石`なしの条件が達成されるため、理性を消費できず、タスクは完了されます。           |
|  C |     1    |    ✖   |    100   |     ✖     | 100回ステージを実行しようとしますが、理性剤を 1 個消費した後に理性が不足した場合、`理性剤使用数：1`、`割る源石の数0`の条件を達成したためタスクは完了します。 |
|  D |    999   |    ✖   |    100   | 3個初級源岩 | 100回ステージを実行しようとし、最大 999 の理性剤を消費しようとしますが、実行中に3個の初級源岩を獲得した場合、`素材を限定：3個の初級源岩`の条件を達成するため、その時点でタスクを完了し停止します。                             |

- クリアした後[penguin-stats](https://penguin-stats.io/)に自動的にアップロードすることができます。
- penguin-statsのIDはカスタマイズ可能です。
- `素材を限定` と `ステージ` は別のオプションです: `素材を限定` 「中級源岩のドロップ数を5」に指定したとしても、対象ステージへ自動的に移動はしません。
- 接続が切断された場合や午前4時に切断された場合は、自動的に再接続され、前回のステージを続けてプレイできます。次の日に進む場合は、前回のステージ選択を確認してください。
- 殲滅作戦もサポートしています。
- クリアした後にドクターレベルがアップした場合でもサポートされています。
- 自動指揮に失敗した場合は、その作戦を自動的に放棄して待機画面へ戻ります。
- 完全な理性消費をサポートします。
  - メインタスクを完了後、自動的に指定したステージに移動し“余剰”理性を消費します。（例：余剰理性を 1-7 に指定した場合）
  - 実行に必要な理性がない場合（例 1-7 を指定し、理性が6未満の場合）即座にタスクを停止します。

### 基地のシフトの切り替え

#### ストラテジー

**単一施設内での最適解**を自動的に計算して選択した上で全てのスキルとスキルの組み合わせをサポートしています。
  作戦記録・純金・源石の欠片・SoCに対応したオペレーターの組み合わせを変えて配置することをサポートします！

#### 基地で働く体力をパーセントで指定可能

体力のパーセントを特定し、体力がしきい値未満のオペレーターは出勤せず、宿舎に直行します。

#### 特別な注意事項

- 基地のシフトは現時点では単一施設内での最適解ですが、施設全体の最適解ではありません。
  例えば、`シャマレ+テキーラ`、`ヴァーミル+シーン` などの組み合わせは認識され、通常どおり使用できます；`ロスモンティス`、`レッドパイン騎士団(フレイムテイル/ファートゥース/ワイルドメイン/アッシュロック)` などの多くの施設間で連携する組合せは一時的にサポートできません。

- `ドローンの使用` で `貿易所-龍門幣` を選択した場合。 `シャマレの組合せ` があるかどうかを識別し、最初に使用します。

- 応接室の手がかりが1つだけ欠けている場合は、該当するスキルのあるオペレーターが選ばれ、そうでない場合は一般オペレーターが選ばれます。
- 応接室は自分の手がかりが溢れた際、手がかり3つのみを譲り渡します。必要な場合、`resource/tasks.json` の `SelectClue` - `maxTimes` フィールドを変更して、譲渡する数をカスタマイズできます。
- 訓練所を使用していない場合 `アイリーニ` などのオペレーターを宿舎に移動させたくない場合は、設定で `作業中のオペレーターを宿舎に移動しない` にチェックしてください。 ただし、この場合、疲労が蓄積していないオペレータも宿舎に入れなくなる可能性があります。
- 制御中枢のストラテジーが複雑すぎるため。現在では `アーミヤ` `スワイヤー` `ケルシー` `レインボー小隊` および体力値が+0.05のスキルのオペレーターのみが考慮されており、今後徐々に最適化される予定です。
- 一部の異格オペレーターは基地で競合します。スタート画面の右側のプロンプトに `オペレーターが競合した` と表示されていないか注意してください。表示されている場合、基地のシフトを手動で確認してください（該当する施設に誰もいない可能性があります）。

### カスタム基地設定

- [Yituliu](https://yituliu.site/riicCal)のエキスパートが、基地シフトをドキュメントでエクスポートできるジェネレーターの作成に協力しました。
- `/resource/custom_infrast/`のフォルダに、非常に効率的なタスクのセットがいくつか組み込まれており、参考として使用することができます。(昇進2の該当オペレーターがいれば、直接使用可能です。)

### 購買部

- 戦友の基地訪問は自動的に行われ、FPポイントを獲得します。
- ワルファリンの金の助けで: 
  - サポートオペレーターを使用し、「青く燃ゆる心」の`OF-1`ステージをクリアします（理性消費無し）。ステージがアンロックされていない場合は、このオプションを選択しないでください。
  - `resource\copilot\OF-1_credit_fight.json`を編集することで、`OF-1`の自動戦闘フローを変更できます（推奨しません）。
  - ステージ選択が`現在/前回`に設定されている場合は、反映されません。

### 自動統合戦略（ローグライク）

![image]()

- 設定で選択できるオプション

- MAA設定で「ファントム/ミヅキ」を選択し、ゲーム内で対応するテーマを「PIN UP」しないと、デフォルトで最新のテーマが表示されるため、不具合が発生する可能性があります。
  - 固定しない場合は、現在の画面がテーマのロビーページ（「探索を始める」/「探索を続ける」ボタンがある）であることを確認してから、この機能を起動してください。
  - 対象外の条件がある場合（例：MAAでミヅキをプレイする予定だが、未達のファントムのセーブがある）、その場合は手動で終了させてください。

<details><summary>固定方法（グローバル版はミヅキ追加後）</summary>

![固定方法](https://user-images.githubusercontent.com/63186641/203422504-22aa0ed9-0f64-4c9f-abca-665e247d13a0.png)

</details>

- 設定は分隊、最初の職業選択（最初に指定するオペレーター）等を設定できます。
- オペレーターや昇進レベルを自動認識し、最適なオペレーターやスキルを自動選択。
- ショップアイテムの識別と、より強力な秘宝の購入の優先順位のサポート。
- 午前4時のアップデート後、ドロップ後の再接続と周回の継続に対応。
- 5分経っても戦闘が終わらない場合は、すべての地上部隊が自動的に退却。6分経つと自動的に戦闘放棄し、無限ループを防ぎます。
- アプリがバグで立ち往生した場合は、現在の冒険を自動的に放棄して再試行します。しかし、どこかで行き詰まって放棄してしまい、効率に深刻な影響を与えることが多い場合は、issueを提出してフィードバックをお寄せください。

### 自動戦闘（現在JP未対応）

自動攻略ファイルのシェアは大歓迎です！<br>
[www.抄作业.com](https://www.抄作业.com) か [www.prts.plus](https://www.prts.plus) をご利用ください!

#### 使い方

- この機能は、`行動開始` のある画面で開始する必要があります。
- サポートを選択する必要がある場合は、`自動編成` オプションをオフにして、手動で編成を決定してから開始してください。
- 役に立ったと思うデータには「いいね！」を押してください。

![image](https://user-images.githubusercontent.com/18511905/189662951-5f9d6d88-3c23-49b3-a58f-c35388b2d5d7.png)

#### 攻略ファイルの作成

- exeと同じディレクトリに簡易メーカーがあり、[自動作戦API](../ja-jp/3.3-自動作戦API.md)と一緒に使用できます。
- マップ座標の取得: `stage_name` を入力して起動すると、ディレクトリ内に `map.png` が生成されます。もしくは [PRTS.map](https://map.ark-nights.com/)  の `設定` から座標を `MAA` に変更しても構いません。
- 演習モードをサポートしているため、テストの際には理性を無駄にする必要はありません。
- ファイルのシェアは大歓迎です！ [www.抄作业.com](https://www.抄作业.com) か [www.prts.plus](https://www.prts.plus) をご利用ください!
- 説明文には、自分の名前（作者名）、参考動画のURL、その他言いたいことなどを記入することをお勧めします

#### 動画ファイルから認識する

- `自動戦闘`の項目に動画をドラッグ&ドロップし、`開始`をクリックします。
- アスペクト比16:9、解像度720p以上の動画にのみ対応しています。動画には、黒枠、歪み補正、エミュレータの枠などが含まれていないことが必須です。

### 公開求人認識

- `スタート画面の公開求人` と `公開求人認識` は別々の2つの機能です！
- 公開求人は `緊急招集票` が利用でき、自動的に継続して求人が行われます！「タスク設定」-「公開求人」から「緊急招集票を自動的に使用」を選択し、「1回の実行あたりの求人の最大回数」を変更してください。


- 星5または星6が確定した場合、ポップアップ通知が表示されます。
- `スタート画面の公開求人` 中に[PenguinStats](https://penguin-stats.io/)と[Yituliu](https://yituliu.site/)へ公開求人データを自動的にアップロードすることができます。

### 倉庫アイテム認識

(ベータ機能) **倉庫を開いた後、素材のタブを選択してから**認識開始を選択してください。現在は複数のデータサイトへの書き出しのみ対応しています。今後、さらに機能を追加していく予定です。
JSONスキーマとの連携をご希望の方は、お気軽にお問い合わせください。

- 現在の対応データサイト

  Arkplanner/JSON

  [Arkplanner](https://penguin-stats.io/planner) / [ARK-NIGHTS.com](https://ark-nights.com/settings)

  Lolicon/JSON

  [アークナイツ ツールボックス](https://arkn.lolicon.app/#/material)

## 設定の紹介

Windows MAAには「設定」タブの他に「タスク設定」もあります。「スタート」のタスクリスト右側の「歯車」をクリックするとスタート内の異なるタスク設定に切り替えることができます〜

「一般設定」「高度な設定」をクリックすると、「タスク設定」も切り替わるので注意してください~

### カスタム接続

#### adbパスの取得

- 方法1：adbをダウンロードして手動で接続を設定する
  - （Windowsユーザーのみ）[adb](https://dl.google.com/android/repository/platform-tools-latest-windows.zip) をダウンロードして解凍します。MAAディレクトリに解凍することをお勧めします。
  - ソフトウェアの「設定」-「接続設定」に進み、`adb.exe`のファイルパスを選択し、adbアドレス（IP +ポートを入力する必要があります。例：`127.0.0.1:5555`）を記入し、エミュレータのタイプを選択します。

- 方法2：エミュレータのadb実行ポートを検索して接続する
  - adbが付属しているエミュレータの場合、[adbアドレスの確認セクション](1.2-FAQ.md#方法1-adb及び接続アドレスが正しいことを確認する)に従って、adb実行可能ファイルの場所を見つけることができます。
  - MacのAndroidエミュレータは通常、`/Application/`ディレクトリにインストールされます。 `[エミュレータ名].app`を右クリックして、「パッケージの内容を表示」を選択します。ディレクトリ内のadb実行可能ファイルを検索します。

#### ポート番号の取得

- 方法1：adbコマンドを使用して実行ポートを直接確認する

  以下のコマンドのadbを、見つかったadb実行可能ファイル名で置き換えて実行します：

  ```sh
  # mac/linux/windows cmd
  adb devices
  # windows PowerShell
  .\adb devices
  ```

  ほとんどのエミュレータadb実行コマンドを実行すると、以下の形式で出力されます。 `[ADBPORT]`は具体的な数字です：

  ```sh
  List of devices attached
        127.0.0.1:[ADBPORT] device
  # may be more output like the above one
  ```

  接続アドレスとして `127.0.0.1:[ADBPORT]` を使用します（`[ADBPORT]`を実際の数字に置き換えます）。

- 方法2: システムコマンドを使用してエミュレータのデバッグポートを確認する

  adbコマンドの出力結果には、ポート情報が `127.0.0.1：[port]` 形式で表示されない場合は、次の方法を使用して確認できます。
    1. まず、adb実行可能ファイルを1回実行します（adbデーモンプロセスを起動する必要があります）。そして、アークナイツアプリのエミュレータを起動します。
    2. 次に、システムコマンドを使用してadbプロセスのポート情報を確認します。

    Windowsのコマンド

    キーボードで `win` + `R` を押して `cmd` を入力し、次のコマンドを使用して確認できます。

    ```sh
    for /F "tokens=1,2" %A in ('"tasklist | findstr "adb""') do ( ^
    netstat -ano | findstr "%B" |)
    ```

    Mac / Linuxのコマンド

    エミュレータを起動したら、ターミナルで次を入力します。

    ```sh
    tmp=$(sudo ps aux | grep "[a]db" | awk '{print $2}') && \
    sudo netstat -vanp tcp | grep -e "\b$tmp"
    ```

    次のような形式の結果が出力されます。`[PID]`はadbが実際に実行されたプロセスID、`[ADBPORT]`はターゲットエミュレータadbのリモート接続ポート、`[localport]`はプロセスのローカルアドレスであり、関係ないです（Macの出力結果には他の無関係な指標が含まれる場合があります）。

    ```sh
    > ( netstat -ano | findstr "[PID]" )
    TCP  127.0.0.1:[localport]   127.0.0.1:0.0.0.0     LISTENING   [PID]
    TCP  127.0.0.1:[localport]   127.0.0.1:[ADBPORT]   ESTABLISHED [PID]
    # ...
    # maybe more output like the above line
    ```

  結果の `127.0.0.1：[ADBPORT]`（[ADBPORT]を実際の数字に置き換える）をエミュレータadbの実際の接続アドレスとして、「設定」-「接続設定」-「接続アドレス」に入力します。

### マルチインスタンスでのシミュレーターの自動起動

- 複数のシミュレーターを同時に操作する必要がある場合は、MAAフォルダを複製し、**別のMAA**、**同じadb.exe**、**異なる接続アドレス**を使用して接続します。
- **`BlueStacks International Version`**を例にして、2つのマルチインスタンスでのシミュレーター起動方法を紹介します。

  - `HD-Player.exe`にコマンドをアタッチしてマルチインスタンスを実行する方法

    1. 対応するエミュレーターを単独で起動します。
    2. タスクマネージャーを開き、対応するエミュレータープロセスを見つけて、詳細情報タブに移動し、上部の列を右クリックして、「列の選択」をクリックします。
    3. 追加された `Command Line` 列から、`...\Bluestacks_nxt\HD-Player.exe"`の後にある内容を見つけます。
    4. `起動設定` - `追加コマンド`に、`--instance Nougat32`のような見つかった内容を入力します。

    注：操作が完了したら、カクつきを防止するために、`ステップ2`で開いた `Command Line` 列を再び非表示にすることをお勧めします。

    - 例:

      ```bash
      複数の起動方法1：
      シミュレーターパス：C：\ Program Files \ BlueStacks_nxt \ HD-Player.exe
      追加コマンド：--instance Nougat32 --cmd launchApp --package "com.hypergryph.arknights"
      複数の起動方法2：
      シミュレーターパス：C：\ Program Files \ BlueStacks_nxt \ HD-Player.exe
      追加コマンド：--instance Nougat32_1 --cmd launchApp --package "com.hypergryph.arknights.bilibili"
      ```

      `--cmd launchApp --package` 部分は、起動後に特定のパッケージ名を持つアプリケーションを自動実行するためのもので、自由に変更できます。

  - エミュレータやアプリのショートカットを使用して、マルチインスタンス操作を実行します。

    1. マルチインスタンスマネージャーを開き、対応するエミュレータのショートカットを追加します。
    2. エミュレータのショートカットのパスを「起動設定」-「エミュレータのパス」に入力します。

    注意：一部のエミュレータは、アプリのショートカットを作成できます。アプリのショートカットでエミュレータを直接起動してArknightsを開くことができます。
    - 例：

      ```bash
      マルチインスタンス1：
      エミュレータのパス：C：\ProgramData\Microsoft\Windows\Start Menu\Programs\BlueStacks\マルチインスタンス1.lnk
      マルチインスタンス2：
      エミュレータのパス：C：\ProgramData\Microsoft\Windows\Start Menu\Programs\BlueStacks\マルチインスタンス2 - Arknights.lnk
      ```

    エミュレータのパスを使用してマルチインスタンス操作を行う場合、起動設定の「追加コマンド」を空白のままにすることをお勧めします。

### 開始前/終了後のスクリプト

- v4.13.0 以降、開始前/終了後のスクリプトを設定できるようになりました。これにより、タスクの前後にバッチファイルを自動的に実行できます。
- バッチファイルのパスを記入する必要があります。拡張子は `.bat` である必要があります。

## その他の注意事項

- スタート画面の左側のタスクのタグは、ドラッグして順序を変更できます。同様に、設定の基地設定のタグの順番もドラッグで変更可能です。
- スタートと設定画面で変更された構成は、「*」でマークされたオプションを除いて、自動的に保存されます。
- すべてのクリック操作は、ボタン内のランダムな位置でのクリックであり、ポアソン分布をシミュレートします（ボタンの中心がクリックされる確率が高く、中心から離れるほどクリックされる確率が小さくなります）。
- 基礎となるアルゴリズムは純粋なC++で開発され、CPUとメモリの使用を最小限に抑えるように複数のキャッシュテクで設計されています。
- アプリは自動更新がサポートされています✿✿ヽ(°▽°)ノ✿、気にならないユーザーはベータ版の使用をお勧めします（更新も速く、バグもほとんどありません）。
- 新しいバージョンの自動ダウンロードが失敗した場合は、パッケージを手動でダウンロードして同じディレクトリに配置すると、自動的に更新されます。
