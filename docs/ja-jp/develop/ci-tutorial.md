---
order: 7
icon: devicon-plain:githubactions
---

# CI システム解析

MAAはGitHub Actionsを活用して、ウェブサイトの構築、リソースの自動更新、ファイルのビルド、バージョンリリースなど、幅広い自動化タスクを実現しています。時間の経過とともに、これらのCIワークフローはより複雑になり、一部は他のリポジトリとも連携しています。このドキュメントは、MAAのCIシステムを改善したい方に向けた簡単な紹介を目的としています。

このドキュメントを読む前に、MAAのプロジェクト構造とコンポーネントについての基本的な理解があることが望ましいです。

::: tip
このページでCIファイル名を検索することで、見たいセクションにすぐに移動できます
:::

ワークフローファイルは`.github/workflows`に保存されており、機能別に以下のように分類できます：

+ [コードテスト](#コードテスト)
+ [コードビルド](#コードビルド)
+ [バージョンリリース](#バージョンリリース)
+ [リソース更新](#リソース更新)
+ [ウェブサイト構築](#ウェブサイト構築)
+ [Issues管理](#issues管理)
+ [Pull Requests管理](#pull-requests管理)
+ [MirrorChyan関連](#mirrorchyan関連)
+ [その他](#その他)

さらに、[pre-commit.ci](https://pre-commit.ci/)を使用してコードの自動フォーマットと画像リソースの最適化を実現しています。これはPR提出後に自動的に実行され、通常は特に注意を払う必要はありません。

## GitHub Action セクション

### コードテスト

`smoke-testing.yml`

このワークフローは主にMaaCoreの基本的なテストを担当しており、リソースファイルのロード、シンプルなタスク実行テストなどが含まれます。

テストケースは長い間更新されていないため、現在このワークフローは主にリソースファイルにエラーがないことと、MaaCoreのコードに致命的なエラー（ビルドに影響を与えるような種類のもの）がないことを確認するために使用されています。

### コードビルド

`ci.yml`

このワークフローは、すべてのMAAコンポーネントを含む全スケールのコードビルドを担当しています。ビルド出力は実行可能なMAAです。

必須のMaaCore以外に、Windowsビルド成果物にはMaaWpfGui、macOSビルド成果物にはMaaMacGui、Linuxビルド成果物にはMaaCLIが含まれます。

このワークフローは新しいコミットとPRがあるたびに自動的に実行されます。リリースPRによってトリガーされると、ビルド成果物は直接リリースに使用され、Releaseが作成されます。

### バージョンリリース

バージョンリリースはユーザーに更新を公開するために必要な操作であり、以下のワークフローで構成されています：

+ `release-nightly-ota.yml` ナイトリービルドのリリース用
+ `release-ota.yml` 安定版/ベータ版のリリース用
  + `gen-changelog.yml` 安定版/ベータ版のチェンジログ生成用
  + `pr-auto-tag.yml` 安定版/ベータ版のタグ生成用

::: tip
上記のファイル名にある「ota」は「Over-the-Air」の略で、一般に「増分更新パッケージ」と呼ばれるものを指します。そのため、MAAのリリースプロセスには、以前のバージョンのOTAパッケージをビルドするステップが含まれています。
:::

#### ナイトリービルド

`release-nightly-ota.yml`

このワークフローは毎日UTC 22:00に自動的に実行され、定期的なナイトリーリリースを確保します。もちろん、変更を検証する必要がある場合は、手動でリリースをトリガーすることもできます。

ナイトリーリリースはWindowsユーザーのみが利用可能であり、macOSおよびLinuxユーザーはナイトリー更新を受け取ることができないことに注意してください。

#### 安定版/ベータ版

これら2つのチャネルのリリースプロセスはやや複雑です。リリースプロセスをシミュレートして、各ワークフローの役割を説明します：

1. `dev`ブランチから`master`ブランチへのPRを作成し、PR名は`Release v******`の形式に従います
2. `gen-changelog.yml`は最近の安定版/ベータ版から現在のバージョンまでのチェンジログを生成します（新しいPRの形式で）
3. チェンジログを手動で調整し、簡単な説明を追加します
4. PRをマージすると、`pr-auto-tag.yml`がトリガーされ、タグの作成とブランチの同期が行われます
5. Releaseイベントはmasterブランチにタグを付けた後、`release-ota.yml`をトリガーし、OTAパッケージをビルドして添付ファイルをアップロードします

### リソース更新

このセクションのワークフローは主にMAAのリソース更新と最適化を担当しており、具体的には：

+ `res-update-game.yml` 定期的に実行され、指定されたリポジトリからゲームリソースを取得します
+ `sync-resource.yml` リソースをMaaResourceリポジトリに同期してリソース更新を行います
+ `optimize-templates.yml` テンプレート画像のサイズを最適化します

### ウェブサイト構築

`website-workflow.yml`

このワークフローは主にMAAの公式ウェブサイトの構築と公開を担当しており、メインページとドキュメントコンポーネントの両方が含まれます。

ウェブサイトの公開はバージョンリリースと強く結びついていることに注意してください。ウェブサイトコンポーネントの通常の変更は、エラーがないことを確認するためのビルドのみをトリガーし、Azureへの正式なデプロイはバージョンリリース時にのみ行われます。

### Issues管理

`issue-checker.yml`

正規表現マッチングを使用してIssuesにタグ付けし、Issue内容を分類してマークし、閲覧と管理を容易にします。

`stale.yml`

90日以上活動のないバグIssuesをチェックし、マークして通知を送信します。7日後も活動がない場合、Issueはクローズされます。

### Pull Requests管理

`pr-checker.yml`

このワークフローはPRコミットメッセージが[Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/)に準拠しているかどうか、およびマージコミットが含まれているかどうかをチェックします。これらの条件が満たされている場合、通知が提供されます。

### MirrorChyan関連

MirrorChyanは有料の更新ミラーサービスです。関連するワークフローには以下があります：

+ `mirrorchyan.yml` 更新パッケージをMirrorChyanに同期します
+ `mirrorchyan_release_note.yml` MirrorChyan用のリリースノートを生成します

### その他

`markdown-checker.yml`

リポジトリ内のすべてのMarkdownファイルで無効なリンクをチェックします

`blame-ignore.yml`

リポジトリ履歴をクリーンに保つため、コミットメッセージに「blame ignore」が含まれるコミットを自動的に無視します

`cache-delete.yml`

PRがマージされた後に関連するキャッシュをクリアし、キャッシュの使用量を節約します
