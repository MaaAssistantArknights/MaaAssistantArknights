---
order: 5
icon: ri:game-fill
---

# 集成戰略協議

::: tip
請注意 JSON 檔是不支援註解的，下方的註解僅用於說明，請勿直接複製使用
:::

## 肉鴿資源儲存位置

- `resource/roguelike/` 下按照主題儲存各個肉鴿的作業資源
  - 主題資料夾：`Phantom/` 為傀影肉鴿資源，`Mizuki/` 為水月肉鴿資源，`Sami/` 為薩米肉鴿資源，`Sarkaz/` 為薩卡茲肉鴿資源，`JieGarden/` 為界園肉鴿資源
    - `autopilot/` 內是各個關卡的作戰 json
      - `關卡名.json` 關卡的作戰邏輯
    - `encounter/` 內是不期而遇類（所有非戰鬥和商店節點）事件邏輯
      - `default.json` 刷等級模式
      - `deposit.json` 刷源石錠模式
    - `recruitment.json` 幹員招募邏輯
    - `shopping.json` 商店購買藏品邏輯

- 特別地，在 `Sami/` 下的
  - `foldartal.json` 表示薩米肉鴿密文板的使用邏輯
  - `collapsal_paradigms.json` 表示薩米肉鴿坍縮範式的類型
  - `autopilot/關卡名_collapse.json` 關卡的作戰邏輯（刷坍縮範式模式）
  - `encounter/collapse.json` 刷坍縮範式模式不期而遇邏輯

- 在 `Sarkaz/` 下的
  - `fragments.json` 存儲了薩卡茲肉鴿思緒的基本資訊
  - `map.json` 存儲了薩卡茲肉鴿藍圖過圖的模板圖片資訊

- 在 `JieGarden/` 下的
  - `coppers.json` 通寶的基本資訊與拾取替換邏輯

## 肉鴿第一步——幹員招募

`resource/roguelike/主題名/recruitment.json` 描述了幹員招募的邏輯
在 `tools/RoguelikeRecruitmentTool` 和 `tools/RoguelikeOperSearch` 中有輔助工具來幫助查看和編寫

```json5
{
    "theme": "Phantom",              //肉鴿主題（這裡是傀影）
    "priority": [                    //群組的優先度，有序
             ...
        ],
    "team_complete_condition": [     //陣容完備度檢測
             ...
        ]
}
```

### 幹員分類

按照你的遊戲理解將幹員分成不同的 **_groups_** （群組，相關概念參考 [戰鬥流程協議](../protocol/copilot-schema.md)）

::: info 注意

1. 同一 group 內的幹員和召喚物必須**部署方式一致**（即同為近戰或者同為高台），**攻擊範圍盡量相同**

2. 允許同一幹員或者召喚物根據用法不同，被分類至不同的 group

3. 請不要修改已經存在的 group 名稱，以免在 MAA 更新時導致之前版本的作業無法使用

4. 請盡量不要新增 group，盡量將新增進作業的單位按照用法納入已經存在的 group

:::

::: tip
預設僅招募精 1 55 級以上等級幹員
:::

```json5
{
    "theme": "Phantom",
    "priority": [                     // 群組，有序
        {
            "name": "棘刺",           // 群組名（這個群組名是棘刺）
            "opers": [                // 群組包含的幹員，有序，代表部署這一組幹員時的部署優先度，
                                      // （比如需要部署該組幹員時，先檢測有沒有棘刺，有棘刺就部署棘刺，沒有棘刺再檢測有沒有號角）
                {
                    "name": "棘刺",   // 幹員名
                    ...
                },
                {
                    "name": "號角",
                    ...
                }
            ]
        },
       "team_complete_condition": [
             ...
        ]
    ]
}
```

1. 已有群組介紹

   以薩米肉鴿的作業為例：主要將幹員分為了

   | 分組                    | 主要考量                       | 主要包括職業          | 舉例幹員                                                         |
   | :---------------------- | :----------------------------- | :-------------------- | :--------------------------------------------------------------- |
   | **_地面阻擋_**          | 站場和清雜                     | 重裝、近衛            | 奶盾、基石、羽毛筆、山、M3、令和稀音的召喚物、斑點、重裝預備幹員 |
   | **_地面單切/處決者_**   | 單獨對戰精英怪                 | 處決者特種            | 史爾特爾、異德、麒麟 R 夜刀、M3、紅                              |
   | **_高台 C_**            | 常態和決戰輸出                 | 狙擊、術士            | 維什戴爾、邏各斯、假日威龍陳、澄閃                               |
   | **_高台輸出_**          | 對空和常態輸出                 | 狙擊、術士            | 空弦、能天使、克洛絲、史都華德                                   |
   | **_速狙_**              | 物理輸出，標準射程             | 狙擊                  | 艾拉、能天使、躍躍、克洛絲                                       |
   | **_術師_**              | 法術輸出，標準射程             | 單法                  | 艾雅法拉、邏各斯、史都華德                                       |
   | **_輔助_**              | 可以打到身後 1 格              | 輔助                  | 塑心、鈴蘭、躍躍、梓蘭                                           |
   | **_狙擊_**              | 射程較遠的高台                 | 投擲手、攻城手        | 維什戴爾、提豐、早露                                             |
   | **_奶_**                | 治療能力                       | 治療、輔助            | 凱爾希、濁心斯卡蒂、芙蓉、安賽爾                                 |
   | **_單奶_**              | 攻擊範圍縱深>=4                | 治療                  | 凱爾希、焰影葦草、純燼艾雅法拉、芙蓉、安賽爾                     |
   | **_群奶_**              | 攻擊範圍縱深<4，可奶身後       | 治療、輔助            | 夜鶯、白面鴞、濁心斯卡蒂                                         |
   | **_回費_**              | 回復 cost                      | 先鋒                  | 桃金娘、伊內絲、芬、香草                                         |
   | **_地刺_**              | 無阻擋，在盾前提供輸出或減速   | 伏擊客                | 歸溟幽靈鯊、阿斯卡綸、獅蠍                                       |
   | **_地面遠程_**          | 地面長手，可以在盾後輸出       | 教官、領主            | 號角、帕拉斯、棘刺、銀灰                                         |
   | **_領主_**              | 地面攻擊範圍縱深>4，可對空     | 要塞、領主            | 棘刺、銀灰、仇白                                                 |
   | **_盾法_**              | 攻擊範圍短，有一定承傷能力     | 陣法術師              | 林、卡涅利安                                                     |
   | **_炮灰_**              | 吸收炮彈、再部署               | 特種、召喚物          | M3、紅、桃金娘、預備幹員                                         |
   | **_大龍_**              | 盾前承傷、緊靠阻擋方便合體     | 召喚物                | 令的小龍、滌火潔西卡的盾牌                                       |
   | **_補給站_**            | 給主 C 幹員加快回轉            | 召喚物                | 支援補給站、工匠類幹員的召喚物                                   |
   | **_無人機_**            | 無視高台地面的治療召喚物       | 召喚物                | 斯卡蒂的海嗣、赫默的無人機                                       |
   | **_支援陷阱_**          | 部署在地面的爆炸物             | 召喚物                | 支援霧機、支援轟隆隆                                             |
   | **_障礙物_**            | 不吃部署位吸引仇恨或者阻擋     | 召喚物                | 鳥籠、障礙物                                                     |
   | **_其他地面_**          | 不希望被優先使用的地面         | 推拉、擋 1 先鋒、劍豪 | 風笛、可頌                                                       |
   | **_高台預備/其他高台_** | 不希望被優先使用的高台         | 群法、鏈法、戰術家    | 梓蘭、預備幹員                                                   |

   ::: tip
   地面阻擋主要考量幹員防守的綜合能力（有時候全殺了也是防守強的表現對吧），包括地面遠程和領主組

   奶主要考慮綜合治療能力，包括單奶和群奶，需要考慮攻擊範圍覆蓋時要單獨使用單奶（奶 4 格）或者群奶（奶身後）

   高台輸出只考慮輸出能力，主要是狙擊和術師職業的混雜排序，需要考慮輸出類型、攻擊範圍等限制條件時單獨使用速狙、術師、輔助、盾法

   夾子類召喚物因為數量較多，不要放在支援陷阱中，讓 maa 自動部署效果比較好
   :::

2. 需要特殊操作的群組

   除了上面那些比較籠統的分組，我們有時候需要對一些幹員或者幹員種類進行一些定制的精細化操作，比如

   | 分組       | 包括幹員         | 主要特點                                                                    |
   | :--------- | :--------------- | :-------------------------------------------------------------------------- |
   | 益達       | 維什戴爾         | 高台輸出，優先部署可以減輕壓力                                              |
   | 棘刺       | 棘刺、號角       | 地面遠程輸出，傀影肉鴿有些圖有非常適合的位置                                |
   | 召喚類     | 凱爾希、令、稀音 | 自帶地面阻擋，有的圖需要優先部署，召喚物可以當阻擋也可以當炮灰              |
   | 情報官     | 曉歌、伊內絲     | 既可以回費、又可以側面輸出、還可以單切                                      |
   | 濁心斯卡蒂 | 濁心斯卡蒂       | 低壓時奶量尚可，但是範圍特殊，一些圖有比較適合的位置                        |
   | 焰葦       | 焰影葦草         | 薩米肉鴿常用開局幹員，兼具治療和輸出，一些圖有比較適合的位置                |
   | 瑪恩納     | 瑪恩納、銀灰     | 地面大範圍決戰輸出，可以針對 boss 進行部署                                  |
   | 史爾特爾   | 史爾特爾         | 由於精二後固定攜帶 3 技能，這時站場能力幾乎為零，需要阻擋位的部署優先度極低 |
   | 骰子       | 骰子             | 水月肉鴿中的骰子需要單獨操作                                                |

::: tip
目前固定將未辨識到的地面幹員歸入倒數第二個編組後面（其他地面），未辨識到的高台幹員歸入倒數第一個編組後面（其他高台）
:::

::: tip
新實裝的幹員需要手動加入各個肉鴿的 `recruitment.json`，而開發者不一定能想起來要做適配
如果你發現了的話可以發 issue 提醒開發者，也可以直接進行 pr
:::

### 預設陣容——陣容完備檢測

在你預計能夠通關或者打到高層的隊伍中，哪些幹員屬於基本核心陣容？是必不可少的？又需要幾個？

::: info 注意
目前腳本的招募邏輯是在陣容未滿足陣容完備度之前，只招募 0 希望（暫時只有三星）和 key（可以理解為白名單）幹員，存希望給高星 key 幹員
（目前的實現方式是給高強度幹員和三星幹員手動標為 key 幹員，招募的時候只招 key 幹員）（TODO: 識別 0 希望幹員）

所以需要盡量讓完備度總數合適，建議所有需要的幹員數量（基本核心陣容，一般是 1 核心，2 地面，1-2 奶，1 高台）加起來在 4-8 位

在隊伍滿足陣容完備度檢測之後，每次拿到招募券會按照幹員的評分和精二優先度進行招募，所以為了避免希望浪費，不希望招募的幹員可以不設定評分或者設定在同職業三星/預備隊員評分以下
（對於一定要和完全不想要的幹員，可以特殊地賦予極高和極低的分數，詳見 `Sami` 中的 `止頌` ）

作戰編隊時會先對幹員選擇介面的預設排序（從上到下、從左到右）進行有序讀取和儲存
基於這個順序，保持相對順序地將最先出現的滿足陣容完備度的幹員提到開頭，直到陣容完備度被全部滿足或不存在滿足陣容完備度的幹員
然後將預備幹員移至最末，形成新的順序，按照新的順序進行選擇
特別地，由於六星臨時招募幹員在編隊時預設位於最開頭，所以實際編隊中很容易編入六星臨時招募幹員（TODO：排除無法使用的精一臨時招募幹員）

對於萌新號：在 10 次招募沒有滿足半隊 key 幹員的情況下，會放棄完備度檢測，按照評分有啥用啥，所以沒練三星的萌新號會出現只拿了兩三個六星，剩下拿了一堆預備幹員的情況
:::

```json5
{
    "theme": "Phantom",              //肉鴿主題
    "priority": [                    //群組
             ...
        ],
    "team_complete_condition": [     //陣容完備度檢測
        {                            //一個策略組 (condition)
            "groups": [              //需要哪些群組中的幹員
                "高台輸出"            //（這裡表示需要高台輸出組的幹員1名）
            ],
            "threshold": 1           //這些幹員需要多少數量
        },
        {                            //可以有多個策略組
            "groups": [
                "棘刺",              //（這裡表示棘刺、地面阻擋、地面單切、炮灰分組的幹員最少需要2個）
                "地面阻擋",
                "地面單切",
                "炮灰"
            ],
            "threshold": 2
        },
        {
            "groups": [
                "奶"                 //（這裡表示需要奶組的幹員1名）
            ],
            "threshold": 1
        }
        ...
        ]
}
```

::: caution
當一個幹員出現在多個幹員組時，只進行一次計數
比如：幹員 `棘刺` 可能同時出現在幹員組 `棘刺` 和 `地面阻擋` 中，在這個策略組內，只對幹員 `棘刺` 計入一次

但每個策略組分別計數
比如：幹員 `焰影葦草` 可能同時出現在幹員組 `高台輸出` 和 `奶` 中，此時兩個策略組都可以計入幹員 `焰影葦草`
:::

### 調整幹員招募參數

1. 群組內的順序代表部署檢測的優先度

2. 臨時招募幹員會在原有的評分基礎上加 600 分

3. 隨機直升幹員的評分是招募評分+精二評分加起來計算

4. 群組內幹員各個欄位的意思和腳本相關的邏輯

   ```json5
   {
       "theme": "Phantom",
       "priority": [
           "name": "地面阻擋",                                // 群組名（這裡是地面阻擋組）
           "doc": "標準線為1檔(清雜能力或者站場能力比山強)>山>2檔(阻擋>2,可自回)>斑點,站場能力小於斑點放到單切或者炮灰組",
                                                             // 帶“doc”欄位均為 json 內註解檔案，對程序執行沒有影響
           "opers": [                                        // 該包括哪些幹員，有序，代表部署優先度
               {
                   "name": "百煉嘉維爾",                      // 幹員名稱（這裡是百嘉，在組內第1位，表示需要部署地面阻擋組的時候，首先檢測是不是百嘉）
                   "skill": 3,                               // 使用幾技能（這裡舉例使用3技能）
                   "skill_usage": 2,                         // 技能使用模式，參考 戰鬥流程協議，不同在於，此處不寫預設為1
                                                             // （0為不自動使用，1為好了就用，2為好了就用x次（x通過"skill_times"欄位設定），3暫時不支援）
                   "skill_times": 2,                         // 技能使用次數，預設為1，在"skill_usage"欄位為2時生效
                   "alternate_skill": 2,                     // 當沒有指定技能時使用的備選技能，一般是6星幹員未精二且精二後使用3技能時才需要指定（這裡指沒有3技能時使用2技能）
                   "alternate_skill_usage": 1,               // 備選技能的技能使用模式（該欄位尚未實現）
                   "alternate_skill_times": 1,               // 備選技能的技能使用次數（該欄位尚未實現）
                   "recruit_priority": 900,                  // 招募優先級，數字越大優先級越高，900以上屬於看到必招，400以下招募優先級比一些關鍵幹員精二優先度還低
                                                             // 臨時招募的幹員優先度自動+600
                   "promote_priority": 600,                  // 進階優先級，數字越大優先級越高，900以上屬於有希望就精二，400以下招募優先級低於招募普通三星幹員
                                                             // 小技巧:當你將招募優先度壓低或者不寫,拉高一些精二優先度,實際上就是在拉高臨時招募到這些幹員的精二優先度
                   "is_key": true,                           // true為 key（關鍵）幹員，false 或省略為非 key 幹員。在陣容完備檢測未通過時，僅招募 key 幹員與 0 希望幹員，保存希望。
                   "is_start": true,                         // true為開局選擇幹員，false 或省略為非開局幹員。在隊伍中沒有 start 幹員時，僅招募 start 幹員與 0 希望幹員
                                                             // 與使用者圖形介面的開局幹員綁定，且使用者手動填寫的幹員會強制設為 start 幹員
                   "auto_retreat": 0,                        // 部署幾秒後自動撤退，整數，大於 0 時生效，主要用於特種幹員和投鋒，由於肉鴿一般是2倍速，建議設為技能持續時間/2
                   "recruit_priority_when_team_full": 850,   // 無需單獨設定，滿足陣容完備度時，招募優先級，預設招募優先級-100
                   "promote_priority_when_team_full": 850,   // 無需單獨設定，滿足陣容完備度時，進階優先級，預設精二優先級+300
                   "recruit_priority_offsets": [             // 按當前陣容調控招募優先級
                       {
                           "groups": [                       // 需要哪些組滿足條件，是按組計數，這些組裡不要出現重複幹員，否則會重複計數
                               "凱爾希",
                               "地面阻擋",
                               "棘刺"
                           ],
                           "is_less": false,                 // 條件是大於還是小於, false 是大於等於, true 是小於等於，不寫預設 false
                           "threshold": 2,                   // 滿足條件的數量，不寫預設0
                           "offset": -300                    // 滿足後對招募優先級的調整，不寫預設0
                                                             // (這裡表示當 凱爾希, 地面阻擋, 棘刺 這三個群組中有2名以上幹員時, 百煉嘉維爾的招募優先級減300)
                       }
                   ]
               },
               ...
           ],
       ],
       "team_complete_condition": [
           ...
       ]
   }
   ```

   ::: info 注意
   `recruit_priority_offsets` 的 `group` 中的群組不要有重複幹員

   `auto_retreat` 設置後一般不需要再在作戰計畫中為其設定 `retreat_plan`
   :::

5. 按照你的理解新增群組和幹員

   新增群組後，你可以從已有的群組中複製幹員過來，參考大佬們已有的評分，在此基礎上修改

## 肉鴿第二步——戰鬥邏輯

`resource/roguelike/主題名/autopilot/關卡名.json` 描述了每個關卡的作戰策略

### MAA 肉鴿通用戰鬥邏輯——牛牛高血壓之源

（在關卡名對應作戰邏輯檔不存在時生效）

1. 根據地圖上格子類型進行基本的戰鬥操作
   - MAA 會根據地圖上的格子是藍門還是紅門，是高台還是地面，能不能被部署來進行基本的戰鬥操作

   - MAA 僅根據地圖名稱或者編號決定使用哪份作業，不會判斷地圖的 **普通**、**緊急**、**路網**、**密文板使用** 等情況

   - MAA 不會判斷 **作戰中地圖上無法確定的格子的情況**，比如 `馴獸小屋` 的祭壇位置，`從眾效應` 是從左邊還是從右邊出怪

   所以在後面，你需要盡量設計一套能夠應付一個地圖名 **所有不同情況**（上面提到的幾種情況）的戰鬥邏輯，小心被大家掛到 issue 上說這張圖操作高血壓哦（笑）

2. MAA 的通用作戰策略--堵藍門
   1. 地面幹員會優先部署在藍門的格子上（為什麽是格子上，請往下看）或者周圍，方向朝向紅門（自動計算），

   2. 優先部署地面，然後部署治療幹員和高台幹員，一圈一圈的由藍門向四周部署，

   3. 會不停的按照上面的邏輯部署可以部署的東西（幹員、召喚物、支援物品等等）

### 優化基本戰鬥策略

1. 藍門替代方案

   僅僅把幹員堆在藍門門口顯然不太聰明，有些關卡有格子是一夫當關萬夫莫開，防守在這裡顯然效率很高，

   或者有些關卡有多個藍門，MAA 不知道哪個藍門對應哪個紅門，也會胡亂部署，

   這個時候你需要打開[地圖 wiki](https://map.ark-nights.com/areas) 一邊對著地圖一邊在腦海裡指揮作戰了

   首先在 `設定` 裡將 `坐標展示` 切換為 `MAA`

   然後根據你的經驗尋找需要優先防守的點的座標和朝向（一般是朝向來怪的方向），寫入到 json 的 `"replacement_home"` 裡面

   ```json5
    {
        "stage_name": "蓄水池", // 關卡名
        "replacement_home": [ // 重要防守點（藍門替代點），至少需要填寫1個
            {
                "location": [ // 格子座標，從地圖 wiki 獲得
                    6,
                    4
                ],
                "direction_Doc1": "優先朝向，但並不代表絕對是這個方向（算法自行判斷）",
                "direction_Doc2": "不填預設 none，即沒有推薦方向，完全由算法自行判斷",
                "direction_Doc3": "none / left / right / up / down / 無 / 上 / 下 / 左 / 右",
                "direction": "left" // （這裡表示將幹員優先部署到座標6,4的格子朝左，周圍自動部署的幹員也盡量朝向左）
            }
        ],
   ```

   ::: tip
   藍門替代方案會在 `deploy_plan` 全部完成但待部署區仍有幹員的情況下生效，邏輯同通用作戰策略
   :::

2. 部署格子黑名單

   有優先防守的點就有優先不部署幹員的點，比如大火球經過的位置，boss 腳底下，一些不好輸出的位置，

   這個時候我們引入了 `"blacklist_location"` 將不想讓他部署幹員的格子加到黑名單裡

   ::: info 注意
   這裡加入的格子，就算在後面的部署策略裡面寫進去的話，也是無法部署的
   :::

   ```json5
       ...
       "blacklist_location_Doc": "這裡是用法舉例，不是說蓄水池這個圖需要 ban 這兩個點",
       "blacklist_location": [  // 禁止程序進行部署的位置
           [
               0,
               0
           ],
           [
               1,
               1
           ]
       ],
   ```

3. 其他地圖策略

   比如水月肉鴿中如果藍門進怪了是不是要用骰子，緩解堆怪壓力

   ```json5
       "not_use_dice_Doc": "藍門幹員撤退時是否需要用骰子，不寫預設 false",
       "not_use_dice": false,
   ```

### 還是高血壓？是時候展現你真正的技術了——定制作戰策略！

使用 `"deploy_plan"` 和 `"retreat_plan"` 實現定制化操作

定制化策略優先於通用戰鬥策略，當定制化策略中的所有步驟都嘗試執行完畢後，省下的幹員或者倒下再部署的幹員會按照通用戰鬥策略不斷部署

有時候不需要設定太多的定制策略，完成關鍵步驟後再交給 MAA，兩者結合可能效果更好

1. 使用各個群組部署幹員

   ```json
    "deploy_plan": [ // 部署邏輯，按從上到下、從左到右的順序進行檢索，並嘗試部署找到的第一個幹員，如果沒有就跳過
           {
               "groups": [ "百嘉", "基石", "地面C", "號角", "擋人先鋒" ],//這一步從這些群組中尋找幹員
               "location": [ 6, 4 ],             //遍歷百嘉群組、基石群組、地面 C 群組等等群組
               "direction": "left"               //將找到的第一個幹員部署到 6,4 這個座標上並朝向左邊
           },                                    //沒找到就進行下一個部署操作
           {
               "groups": [ "召喚" ],
               "location": [ 6, 3 ],
               "direction": "left"
           },
           {
               "groups": [ "單奶", "群奶" ],
               "location": [ 6, 2 ],
               "direction": "down"
           }
       ]

   ```

   ::: info 注意
   MAA 會將所有部署指令扁平化後，執行最優先級部署操作
   例：在 [6,4] 部署 [ "百嘉", "基石", "地面 C"]，在 [6,3] 部署 [ "基石", "地面 C"]，那麼 MAA 會將部署指令扁平化成附帶座標的 [ "百嘉", "基石", "地面 C"，"基石", "地面 C"]
   如果在戰鬥中 [6,4] 位置的 "百嘉" 組幹員倒下，手裡有可部署的「基石」組幹員，會優先布置到 [6,4] 而不是 [6,3]

   這意味著從宏觀上來看，每次執行完部署動作之後都會從頭開始檢查可執行的策略（當前步驟的位置沒有已經放置的幹員，且待部署區有幹員屬於此步驟的幹員組）
   :::

   ::: tip
   一些常用的幹員組用法:

   1. 很多作業中主要防守點的組合是 [ "地面阻擋", "處決者", "其他地面"]，這意味著當主要抗傷位幹員死了會嘗試用處決者拖延 cd；當這個點生存壓力過大時，考慮使用 [ "重裝","地面阻擋", "處決者", "炮灰", "其他地面"]；盾後的點則可以優先盾後輸出 [ "地面遠程","地面阻擋", "處決者", "其他地面"]；單純吸引仇恨或送死可以使用 [ "炮灰", "障礙物", "其他地面"]

   2. 高台位組合常用 [ "高台輸出", "其他高台"]，想要無論什麼高台都可以放置可以使用 [ "高台輸出", "狙擊", "輔助", "盾法", "其他高台"]

   3. 一些地面位置叔叔和地刺類幹員都比較適合 [ "瑪恩納", "地刺"]
   :::

2. 在某個時間點部署幹員
   ::: tip
   適用於某些單切幹員或者需要炮灰的使用場景
   :::

   ```json
   "deploy_plan": [
           {
               "groups": [ "異德", "刺客", "擋人先鋒", "其他地面" ],
               "location": [ 5, 3 ],
               "direction": "left",
               "condition": [ 0, 3 ]       // 該操作僅在擊殺數為0-3時進行
           },
           {
               "groups": [ "異德", "刺客", "擋人先鋒", "其他地面" ],
               "location": [ 5, 3 ],
               "direction": "left",
               "condition": [ 6, 10 ]
           },
           ...
       ]
   ```

3. 在某個時間點撤退幹員
   ::: tip
   有時候炮灰過強站住場或者需要部署位騰挪陣容怎麽辦，撤退！

   同一位置的部署和撤退命令的 condition 數字盡量不要重疊，否則會秒上秒下
   :::

   ```json
    "retreat_plan": [  // 在特定時間點撤退目標
           {
               "location": [ 4, 1 ],
               "condition": [ 7, 8 ] // 在擊殺數為7-8時，撤去位置[4,1]的幹員，沒有就跳過
           }
       ]
   ```

4. 在某個時間點釋放技能（to do）

5. 一些其他的欄位（不推薦使用）

   ```json
       "role_order_Doc": "幹員類型部署順序，未寫出部分以近衛，先鋒，醫療，重裝，狙擊，術士，輔助，特種，召喚物的順序補全，輸入英文",
       "role_order": [ // 不推薦使用，請配置deploy_plan欄位
           "warrior",
           "pioneer",
           "medic",
           "tank",
           "sniper",
           "caster",
           "support",
           "special",
           "drone"
       ],
       "force_air_defense_when_deploy_blocking_num_Doc": "場上有10000個阻擋單位時就開始強制部署總共1個對空單位（填不填寫均不影響正常部署邏輯），在此期間不禁止部署醫療單位（不寫預設false）",
       "force_air_defense_when_deploy_blocking_num": { // 不推薦使用，請配置deploy_plan欄位
           "melee_num": 10000,
           "air_defense_num": 1,
           "ban_medic": false
       },
       "force_deploy_direction_Doc": "這些點對某些職業強制部署方向",
       "force_deploy_direction": [ // 不推薦使用，請配置deploy_plan欄位
           {
               "location": [
                   1,
                   1
               ],
               "role_Doc": "填入的職業適用強制方向",
               "role": [
                   "warrior",
                   "pioneer"
               ],
               "direction": "up"
           },
           {
               "location": [
                   3,
                   1
               ],
               "role": [
                   "sniper"
               ],
               "direction": "left"
           }
       ],
   ```

::: info 注意
當 maa 無法找到當前關卡對應的定制作戰策略時，會自動執行通用作戰策略

當 maa 對當前關卡名稱識別失敗後，不會執行任何作戰邏輯
:::

### 對某個幹員打法有特殊理解？——精細化操作特定幹員

請將這位幹員單獨分組

編寫作業時請考慮這位幹員與現有作業的順序優先度

你也可以不考慮那麽多，單獨為這個幹員寫一份作戰邏輯

僅使用一位幹員也是可行的！使用 MAA 來凹單人通關吧（由於其他邏輯的不完善，可能性很低）

參考例子：1.傀影肉鴿的棘刺，2.水月肉鴿的異德，3.薩米肉鴿的焰影葦草/維什戴爾，4.薩卡茲肉鴿的維什戴爾

## 肉鴿第三步——不期而遇類節點邏輯

`resource/roguelike/主題名/encounter/default.json` 描述了刷等級模式下不期而遇事件選擇的策略

`resource/roguelike/主題名/encounter/deposit.json` 描述了刷源石錠模式和刷開局模式下不期而遇事件選擇的策略

### MAA現有對不期而遇的判斷方法

OCR 辨識不期而遇事件名稱，但是選項是操作固定的位置

事件名識別失敗的話會點選項類型圖示（若有），或點最下面的選項

一個常見的卡死原因就是選項類型的圖示存在但選項不可選（TODO）

改進肉鴿邏輯時，一般只需要微調或者不調整（大佬都寫好了嘛）

### 優化不期而遇選項的優先度

請結合 [prts.wiki](https://prts.wiki/w/%E9%9B%86%E6%88%90%E6%88%98%E7%95%A5) 查看各個事件的選項效果，注意選項不一定固定

可以自己修改不期而遇事件選項以指引 MAA 走向某些圖的特殊結局

```json
{
    "theme": "Sami",                              //肉鴿主題
    "stage": [                                    //不期而遇類事件
        {
            "name": "低地市集",                    //不期而遇事件名稱
            "option_num": 3,                      //總共有幾個選項（這裡是3）
            "choose": 3,                          //優先選擇第幾個選項（這裡優先選第三個），如果選不到就選跑路選項（基本上是最後一個）
            "choices": [                          //選擇選項的要求（暫時不影響程序運行，只做適用情況的標註方便修改）
                {
                    "name": "選擇碎草藥",          //選項的名字
                    "ChaosLevel": {               //壓力等級
                        "value": "3",             //要求的數字
                        "type": ">"               //是大於還是小於（這裡表示壓力大於3時才啟動選擇碎草藥選項）
                    }
                },
                {
                    "name": "選擇好看的織物",
                    "ChaosLevel": {
                        "value": "3",
                        "type": ">"
                    }
                },
                ...
```

### 根據隊伍情況動態調整某些選項的優先度（TODO）

## 肉鴿第四步——商店藏品的優先度

`resource/roguelike/主題名/shopping.json` 描述了商店購買藏品(和戰鬥後選擇藏品?)的策略

```json
{
    "theme": "Phantom",                                       //肉鴿主題名（這裡是傀影）
    "priority": [                                             //優先度,有序,順序即為優先級,越在前面越優先購買,
                                                              //但優先級判斷在chars,roles的篩選之前, 可能出現高優先級商品被篩掉, 什麼都不買的情況
        {
            "name": "金酒之杯",                                //藏品名字（這裡金杯）
            "no_longer_buy": true,                             //true表示獲得該藏品後不在花錢買藏品，false或者省略表示繼續花錢買藏品
            "ignore_no_longer_buy": true,                      //true表示商店有該藏品時忽略"no_longer_buy",就是還會買它，false或者省略表示拿到有"no_longer_buy"的藏品後不會購買這個藏品
            "effect": "每有5源石錠，所有我方單位的攻擊速度+7",    //藏品效果（不影響程序運行，備註效果方便排序）
            "No": 167                                          //藏品編號,wiki可查（不影響程序運行，備註方便排序）
        },

        ...
        {
            "name": "擴散之手",
            "chars": [                                         //隊伍中有這些幹員的時候買這件藏品
                "異客"                                         //（這裡表示隊伍中有異客時，遇到擴散之手，就會嘗試購買）
            ],
            "effect": "【擴散術師】、【鏈術師】和【轟擊術師】每對一個單位造成傷害就回覆2點技力值",
            "No": 136
        },
        ...

        {
            "name": "折戟-破釜沉舟",
            "roles": [                                         //隊伍中有這些職業的時候買這件藏品
                "WARRIOR"                                      //（這裡表示隊伍中有近衛幹員時，遇到折戟-破釜沉舟，就會嘗試購買）
            ],
            "effect": "所有【近衛】幹員的防禦力-40%，但攻擊力+40%，攻擊速度+30",
            "No": 16
        },
        ...

        {
            "name": "Miss.Christine摸摸券",
            "promotion": 2,                                   //隊伍中有2個幹員要晉升的時候購買（吧？）
            "effect": "立即進階兩個幹員（不消耗希望）",
            "No": 15
        },
        ...

        {
            "name": "警戒籬木",
            "effect": "坍縮值-2，目標生命上限+2",
            "No": 198,
            "decrease_collapse": true                          // true表示獲得該藏品會降低坍縮值。在mode為5時將不會購買
        },
        ...

    "others":                                                  // maa不會購買的收藏品，比如結局藏品和起重機
        {
            "name": "無人起重機"
        },
```

## 肉鴿特殊機制

### 薩米肉鴿——密文板

`resource/roguelike/Sami/foldartal.json` 描述了薩米肉鴿密文板的策略

```json5
{
    "theme": "Sami",                                         //肉鴿主題名（這裡是薩米）
    "groups": [                                              //對使用情況和用法的分組
        {
            "usage": "SkipBattle",                           //用法（這裡是跳過戰鬥,用於刷錢和燒水模式的作戰節點,使用板子跳過戰鬥以節省時間）
            "doc": "跳過戰鬥,刷錢和燒開水模式",
            "pairs": [                                       //板子對(遇到對應的節點時,會判斷有沒有符合下面設定的板子對,如果有,就使用能用的全用,如果沒有就直接進點)
                {                                            //（這裡傷痕只能和空無聯結）
                    "up": [                                  //上板子
                        "傷痕"
                    ],
                    "down": [                                //下板子
                        "空無"
                    ]
                },
                {                                            //（這裡會按順序搜索 "黜人"+"驚訝","黜人"+ "疑惑","黜人"+...,"獵手"+"驚訝","獵手"+ "疑惑","獵手"+... , ...）
                    "up": [
                        "黜人",
                        "獵手",
                        ...
                    ],
                    "down": [
                        "驚訝",
                        "疑惑",
                        ...
                    ]
                }
            ]
        },
        {
            "usage": "Boss",                                 //（這裡表示遇到 boss 點會用的板子對）
            "doc": "有的用全用了",
            ...
        }
    ],
    "foldartal": [                                          //密文板效果備註（這裡僅做備註方便查看板子效果，不影響程序運行）
        {
            "name": "佈局",                                  //密文板類型（上板子還是下板子）
            "foldartal": [
                {
                    "name": "黜人",                           //密文板名稱
                    "effect": "選擇所有右側鄰近的戰鬥節點"     //密文板效果
                },

```

### 薩米肉鴿——坍縮範式

當 `check_collapsal_paradigms` 為 `true` 時，MAA 將以兩種不同的手段檢查坍縮範式：

- 在選關介面點擊螢幕中上方展開坍縮狀態欄，以下稱 Panel Check ；
- 觀察螢幕右側是否有坍縮範式通知 以下稱 Banner Check 。

獲取坍縮值的方法多種多樣，我們考慮到了以下情況：

1. 戰鬥後因非完美戰鬥而使坍縮值增加，進行 Banner Check 。
2. 戰鬥後因獲得收藏品而使坍縮值變動，進行 Banner Check 。
3. 在不期而遇等節點中因選擇選項而使坍縮值變動，進行 Banner Check 。
4. 再詭異行商節點中因購買收藏品而使坍縮值變動，進行 Banner Check 。
5. 因使用密文版而使坍縮值減少，進行 Banner Check 。
6. 因進入新的一層而使坍縮值增加，進行 Panel Check 。
7. 若進行 Banner Check 時發現坍縮範式消退，因不知道會不會一次性消退兩層（即便會也機率極低），會在下一次回到選關介面的時候額外觸發一次 Panel Check 。
8. 在 `double_check_collapsal_paradigms` 為 `true` 的情況下，每次回到選關介面的時候都會額外觸發一次 Panel Check 以驗證是否之前有漏、多記錄坍縮範式。

以下為刷隱藏坍縮範式的任務配置示例：

```json5
{
    "theme": "Sami",
    "mode": 5,
    "investment_enabled": false,
    "squad": "遠程戰術分隊",
    "roles": "穩紮穩打",
    "core_char": "維什戴爾",
    "expected_collapsal_paradigms": ["目空一些", "睜眼瞎", "圖像損壞", "一抹黑"]
}
```

當 `mode` 為 `5` 時：

- 優先使用 `stage_name` 為 `關卡名_collapse` 的作戰策略，例如 `resource/roguelike/Sami/autopilot/事不過四_collapse.json`；
- 使用 `resource/roguelike/Sami/encounter/collapse.json` 中描述的不期而遇事件選擇的策略，
- 不會購買 `decrease_collapse` 為 `true` 的藏品。

當 `mode` 不為 `5` 但 `check_collapsal_paradigms` 為 `true` 時，仍會檢測坍縮範式並在遇到 `expected_collapsal_paradigms` 列表中的坍縮範式時停止任務，但在遇到其他坍縮範式時將不會重開。

刷隱藏坍縮範式時，推薦 N10 難度，建議使用以下隊伍：

- 維什戴爾 + 斑點 + 史都華德；
- 焰影葦草 + 梓蘭 + 泡普卡；
- 提豐 + 斑點 + 史都華德。

### 界園肉鴿——通寶

`resource/roguelike/JieGarden/coppers.json` 描述了界園肉鴿通寶的設定和交換策略

```json5
{
    "theme": "JieGarden",                                    //肉鴿主題名（這裡是界園）
    "addons": {                                              //通寶附加屬性說明（僅作註釋，不影響程序運行）
        "鏽色": "投出時，每經過一個節點，獲得源石錠+1",
        "存護": "加入錢盒時，獲得護盾值+2",
        "入幻": "加入錢盒時，獲得希望+1",
        "引光": "加入錢盒時，獲得燭火+1",
        "巡遊": "投出時，每完成一場戰鬥，獲得票券+1"
    },
    "coppers": [                                             //通寶列表
        {
            "name": "大炎通寶",                              //通寶名稱
            "desc": "普通又空白，什麼也沒有",                //通寶效果描述（僅作註釋，不影響程序運行）
            "rarity": "NORMAL",                             //稀有度：NONE/NORMAL/RARE/SUPER_RARE（僅作註釋，不影響程序運行）
            "pickup_priority": 0,                           //拾取優先級，在掉落選擇時使用，數值越高越優先拾取
            "discard_priority": 1000                        //丟棄優先級，在交換時使用，數值越高越優先被丟棄
        },
        {
            "name": "衡-奇土生金",
            "desc": "投出時，立即獲得源石錠+4（下次投錢前變化為-大炎通寶）",
            "rarity": "NORMAL",
            "pickup_priority": 200,
            "discard_priority": 800,
            "cast_discard_priority": 999                    //可選欄位，已投出時的丟棄優先級，僅在已投出且值>=0時替代 discard_priority
                                                            //這通常適用於一些投出後效果發生變化的通寶（如變為大炎通寶的通寶）
        },
        {
            "name": "厲-西廉貞",
            "desc": "投出時，精英及領袖敵人的生命值、攻擊力+10%，在險路惡敵及歲獸殘識中攻擊力、生命值額外+20％",
            "rarity": "NORMAL",
            "pickup_priority": 0,
            "discard_priority": 1998,
            "cast_discard_priority": 2098                   //同上，有時也會用在一些投出後帶來負面效果的通寶
        },
        ...
    ]
}
```

#### 通寶交換邏輯

MAA 在界園肉鴿中會自動處理通寶的拾取和交換：

::: tip 啟用條件
通寶交換功能僅在以下模式中啟用：

- 投資模式：需要開啟"投資模式啟用購物、招募、進2層"選項
- 其他模式：預設啟用

:::

1. **拾取掉落通寶**：在戰鬥結束後，如果出現通寶掉落選擇介面，MAA 會根據 `pickup_priority` 選擇優先級最高的通寶

2. **交換錢盒通寶**：當新拾取的通寶需要與錢盒中的通寶交換時：
   - 識別錢盒中所有通寶的類型、名稱和是否已投出狀態
   - 找到錢盒中 `discard_priority` 最高（最不重要）的通寶
   - 如果新通寶的 `discard_priority` 比最不重要的現有通寶更低，則放棄交換
   - 否則將最不重要的通寶替換為新通寶

3. **已投出通寶的特殊處理**：
   - 對於標記了 `cast_discard_priority` 的通寶，在已投出狀態時使用該優先級而非 `discard_priority`
   - 這通常適用於一些投出後效果發生變化的通寶（如變為大炎通寶的通寶）

#### 通寶識別機制

MAA 使用以下方法識別和處理通寶：

1. 透過模板比對識別通寶的類型圖示（厲/衡/花）
2. 基於類型圖示的位置，使用 ROI 偏移進行 OCR 識別通寶名稱
3. 識別通寶是否處於"已投出"狀態
4. 在通寶交換介面中自動滑動列表，掃描所有通寶進行比較

#### 識別流程示意

![image](/images/zh-cn/copper-explanation-1.png)
![image](/images/zh-cn/copper-explanation-2.png)

::: info 注意

- 如果 OCR 識別的通寶名稱在配置檔中未找到，MAA 會保存調試圖像到 `debug/roguelike/coppers/unknown` 目錄，以供排查

:::

## 希望實現的邏輯（TODO）

### 自動編隊邏輯

1. 可以根據不同地圖設定不同的地圖陣容完備性檢測和技能優先度

2. 可以根據現有陣容避開一些難度高的作戰

### ~~優化尋路算法~~（已初步實現）

比如可以實現前三層多戰,後面的少戰,這樣發育會更好

比如識別節點間的連線來判斷更優路徑

### 技能保留

某格部署的幹員，技能轉好後等待 x 秒再開，方便對軸；可以寫 Deploy_plan 下的 Skill_hold，也可以寫 Skill_hold_plan

### 技能關閉

對彈藥類幹員有用

<!-- markdownlint-disable-file MD026 -->
